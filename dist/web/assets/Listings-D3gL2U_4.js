import{h as ke,u as ye,r as d,j as e}from"./vendor-react-DzgxJkbp.js";import{a as fe,u as pe,b as te}from"./vendor-query-BeqrpgNA.js";import{u as be,a as me,b as we,c as _e,d as Le,e as Ce,f as U}from"./index-DJAOEm-v.js";import{P as xe,b as $,I as p,x as re,B as oe,T as a,a as u,L as P,C as D,c as H,i as Pe,e as q,D as T,y as he,l as Ae,f as le,o as E,z as ce,E as je,G as ve,H as A,S as Me,d as ge,J as Be,K as $e,M as De,O as Ee,Q as Ne}from"./vendor-polaris-o1SQP_xq.js";const de=s=>s==null?"—":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(s),Oe=s=>{if(!s)return"—";const o=typeof s=="number"?s>1e12?s:s*1e3:Date.parse(s);if(Number.isNaN(o))return"—";const j=new Date(o),v=new Date().getTime()-j.getTime();return v<6e4?"Just now":v<36e5?`${Math.floor(v/6e4)}m ago`:v<864e5?`${Math.floor(v/36e5)}h ago`:j.toLocaleDateString()},se=s=>{if(!s)return"—";const o=typeof s=="number"?s>1e12?s:s*1e3:Date.parse(s);return Number.isNaN(o)?"—":new Date(o).toLocaleString()},Se=s=>{const o=s.shopifyProductId??s.shopify_product_id??String(s.shopifyProductID??s.id??"");return{id:String(s.id??o),shopifyProductId:String(o),ebayListingId:s.ebayListingId??s.ebay_listing_id??s.ebayItemId??null,ebayInventoryItemId:s.ebayInventoryItemId??s.ebay_inventory_item_id??null,status:s.status??"inactive",originalPrice:s.originalPrice??s.original_price??s.shopifyPrice??s.shopify_price??s.price??null,lastRepublishedAt:s.lastRepublishedAt??s.last_republished_at??null,promotedAt:s.promotedAt??s.promoted_at??null,adRate:s.adRate??s.ad_rate??null,createdAt:s.createdAt??s.created_at??null,updatedAt:s.updatedAt??s.updated_at??null,shopifyTitle:s.shopifyTitle??s.shopify_title,shopifySku:s.shopifySku??s.shopify_sku}},ae=s=>!!(s&&s.startsWith("draft-")),V=s=>{if(!s.ebayListingId)return{label:"Missing",tone:"critical"};if(ae(s.ebayListingId))return{label:"Draft",tone:"info"};const o=s.status.toLowerCase();return o==="active"||o==="synced"?{label:"Active",tone:"success"}:o==="error"||o==="failed"?{label:"Error",tone:"warning"}:o==="inactive"?{label:"Inactive",tone:"info"}:o==="pending"?{label:"Pending",tone:"attention"}:{label:s.status||"Unknown",tone:"info"}},ne=({label:s,value:o,icon:j,tone:f})=>e.jsx(D,{children:e.jsxs(p,{gap:"300",blockAlign:"center",children:[e.jsx($,{background:f==="success"?"bg-fill-success-secondary":f==="critical"?"bg-fill-critical-secondary":f==="warning"?"bg-fill-warning-secondary":"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(H,{source:j,tone:f??"base"})}),e.jsxs(u,{gap:"050",children:[e.jsx(a,{variant:"headingMd",as:"p",children:o}),e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:s})]})]})}),qe=()=>{const{id:s}=ke(),o=ye(),j=fe(),{addNotification:f}=be(),{data:v,isLoading:J,error:b}=me({limit:50,offset:0,search:s}),i=d.useMemo(()=>{const t=(v?.data??[]).map(Se);return t.find(r=>r.shopifyProductId===s||r.id===s)??t[0]??null},[v,s]),{data:w,isLoading:z}=pe({queryKey:["product-info",s],queryFn:()=>U.get(`/test/product-info/${s}`),enabled:!!s}),S=w?.product?.variant?.sku??i?.shopifySku,{data:I,isLoading:N}=pe({queryKey:["ebay-offer",S],queryFn:()=>U.get(`/test/ebay-offer/${S}`),enabled:!!S}),{data:K}=we(),{data:M}=_e(s),Q=Le(),[B,k]=d.useState({}),[O,W]=d.useState(!1),[F,_]=d.useState(!1),X=d.useCallback((t,r)=>{if(!r||!t)return"";if(t.includes("[0].")){const[c,m]=t.split("[0].");return String(r[c]?.[0]?.[m]??"")}return String(r[t]??"")},[]),R=d.useMemo(()=>{if(!K)return{};const t={},r=["sales","listing","shipping","payment"],c=K,m=w?.product;for(const C of r){const G=(c[C]??[]).filter(x=>x.is_enabled!==!1).map(x=>{let L="";switch(x.mapping_type){case"shopify_field":L=X(x.source_value||"",m);break;case"constant":L=x.target_value||"";break;case"formula":L=x.source_value||"";break;default:L="";break}return{field_name:x.field_name,mapping_type:x.mapping_type,resolved:L,display_order:x.display_order}}).sort((x,L)=>x.display_order-L.display_order);G.length>0&&(t[C]=G)}return t},[K,w,X]);d.useEffect(()=>{const t={};for(const[r,c]of Object.entries(R))for(const m of c)t[`${r}::${m.field_name}`]=m.resolved;if(M?.data)for(const r of M.data)r.value&&(t[`${r.category}::${r.field_name}`]=r.value);k(t),W(!1)},[M,R]);const Y=d.useCallback((t,r,c)=>{k(m=>({...m,[`${t}::${r}`]:c})),W(!0),_(!1)},[]),Z=d.useCallback(()=>{if(!s)return;const t=[];for(const[r,c]of Object.entries(B)){if(c.trim()==="")continue;const[m,C]=r.split("::");t.push({category:m,field_name:C,value:c})}Q.mutate({shopifyProductId:s,overrides:t},{onSuccess:()=>{W(!1),_(!0)}})},[s,B,Q]),ee={sales:"Sales",listing:"Listing",shipping:"Shipping",payment:"Payment"},ie=t=>t.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()),n=te({mutationFn:()=>U.put(`/sync/products/${s}`),onSuccess:()=>{j.invalidateQueries({queryKey:["listings"]}),f({type:"success",title:"Sync started",autoClose:4e3})},onError:t=>{f({type:"error",title:"Sync failed",message:t instanceof Error?t.message:"Unknown error"})}}),l=te({mutationFn:()=>U.post(`/sync/products/${s}/end`),onSuccess:()=>{j.invalidateQueries({queryKey:["listings"]}),f({type:"success",title:"Listing ended",autoClose:4e3})},onError:t=>{f({type:"error",title:"Failed to end listing",message:t instanceof Error?t.message:"Unknown error"})}}),g=d.useMemo(()=>i?[{label:"Created",value:se(i.createdAt)},{label:"Last updated",value:se(i.updatedAt)},{label:"Last republished",value:se(i.lastRepublishedAt)},{label:"Promoted",value:se(i.promotedAt)}].filter(t=>t.value!=="—"):[],[i]),h=w?.product,y=h?.variant,ue=[{content:"End listing",destructive:!0,onAction:()=>l.mutate()}];return i?.ebayListingId&&!ae(i.ebayListingId)&&ue.push({content:"View on eBay",onAction:()=>window.open(`https://www.ebay.com/itm/${i.ebayListingId}`,"_blank")}),e.jsxs(xe,{title:h?.title??i?.shopifyTitle??"Product detail",subtitle:i?.shopifyProductId?`Shopify ID ${i.shopifyProductId}`:void 0,backAction:{content:"Back to eBay listings",onAction:()=>o("/ebay/listings")},primaryAction:{content:"Sync now",onAction:()=>n.mutate(),loading:n.isPending},secondaryActions:ue,fullWidth:!0,children:[(J||z)&&e.jsx($,{padding:"800",children:e.jsx(p,{align:"center",children:e.jsx(re,{accessibilityLabel:"Loading product detail",size:"large"})})}),b&&e.jsx(oe,{tone:"critical",title:"Unable to load product detail",children:e.jsx(a,{as:"p",children:b instanceof Error?b.message:"Something went wrong."})}),i&&e.jsxs(u,{gap:"500",children:[e.jsx(P,{children:e.jsx(P.Section,{children:e.jsx(D,{children:e.jsxs(u,{gap:"400",children:[e.jsxs(p,{gap:"300",align:"space-between",blockAlign:"center",children:[e.jsxs(p,{gap:"200",blockAlign:"center",children:[e.jsx($,{background:"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(H,{source:Pe})}),e.jsx(a,{variant:"headingMd",as:"h2",children:"Shopify product"})]}),h?.status&&e.jsx(q,{tone:"info",children:h.status})]}),e.jsx(T,{}),e.jsxs(p,{gap:"400",align:"start",children:[e.jsxs(u,{gap:"200",children:[e.jsx(he,{size:"large",source:h?.image?.src||h?.images?.[0]?.src||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png",alt:h?.title??"Product image"}),h?.images&&h.images.length>1&&e.jsxs(p,{gap:"100",wrap:!0,children:[h.images.slice(0,6).map((t,r)=>e.jsx(he,{size:"small",source:t.src,alt:`Image ${r+1}`},t.id??r)),h.images.length>6&&e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"span",children:["+",h.images.length-6," more"]})]})]}),e.jsxs(u,{gap:"200",children:[e.jsx(a,{variant:"headingLg",as:"h3",children:h?.title??i.shopifyTitle??"Untitled product"}),e.jsxs(a,{variant:"bodyMd",tone:"subdued",as:"p",children:["SKU: ",y?.sku??i.shopifySku??"—"]}),e.jsxs(a,{variant:"bodyMd",as:"p",children:["Price: ",de(Number(y?.price??i.originalPrice??0)||null)]}),e.jsxs(a,{variant:"bodyMd",as:"p",children:["Inventory: ",y?.inventory_quantity??"—"]}),e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"p",children:["Inventory Item ID: ",y?.inventory_item_id??i.ebayInventoryItemId??"—"]})]})]})]})})})}),e.jsx(P,{children:e.jsx(P.Section,{children:e.jsx(D,{children:e.jsxs(u,{gap:"400",children:[e.jsxs(p,{gap:"300",align:"space-between",blockAlign:"center",children:[e.jsxs(p,{gap:"200",blockAlign:"center",children:[e.jsx($,{background:"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(H,{source:Ae})}),e.jsx(a,{variant:"headingMd",as:"h2",children:"eBay listing"})]}),e.jsx(q,{tone:V(i).tone,children:V(i).label})]}),e.jsx(T,{}),N?e.jsx(re,{accessibilityLabel:"Loading eBay details",size:"small"}):e.jsxs(le,{columns:{xs:1,sm:2},gap:"300",children:[e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Listing ID"}),e.jsx(a,{variant:"bodyMd",as:"p",children:i.ebayListingId??"—"})]}),e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Offer ID"}),e.jsx(a,{variant:"bodyMd",as:"p",children:I?.offer?.offerId??"—"})]}),e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"eBay price"}),e.jsx(a,{variant:"bodyMd",as:"p",children:de(Number(I?.offer?.price??0)||null)})]}),e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Available"}),e.jsx(a,{variant:"bodyMd",as:"p",children:I?.offer?.quantity??I?.inventoryItem?.quantity??"—"})]}),e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Condition"}),e.jsx(a,{variant:"bodyMd",as:"p",children:I?.inventoryItem?.condition??"—"})]})]}),e.jsx(T,{}),e.jsx(p,{gap:"200",children:ae(i.ebayListingId)?e.jsx(q,{tone:"info",children:"Draft — not yet published"}):e.jsxs(e.Fragment,{children:[e.jsx(E,{icon:ce,onClick:()=>i.ebayListingId&&window.open(`https://www.ebay.com/itm/${i.ebayListingId}`,"_blank"),disabled:!i.ebayListingId,children:"View on eBay"}),e.jsx(E,{icon:ce,onClick:()=>window.open(`https://www.ebay.com/sh/lst/active?q=${encodeURIComponent(i.shopifySku||"")}`,"_blank"),disabled:!i.ebayListingId,children:"Edit on eBay"})]})})]})})})}),e.jsx(P,{children:e.jsx(P.Section,{children:e.jsx(D,{children:e.jsxs(u,{gap:"400",children:[e.jsxs(p,{align:"space-between",blockAlign:"center",children:[e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"headingMd",as:"h2",children:"eBay listing fields"}),e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:"Values sent to eBay. Edit any field to override the default mapping."})]}),e.jsx(E,{variant:"primary",onClick:Z,loading:Q.isPending,disabled:!O,children:"Save changes"})]}),F&&e.jsx(oe,{tone:"success",title:"Changes saved successfully",onDismiss:()=>_(!1)}),Object.keys(R).length===0?e.jsx(a,{tone:"subdued",as:"p",children:"No mapping data available. Configure mappings first."}):Object.entries(R).map(([t,r])=>e.jsxs(u,{gap:"300",children:[e.jsxs(p,{gap:"200",blockAlign:"center",children:[e.jsx(a,{variant:"headingSm",as:"h3",children:ee[t]??t}),e.jsx(q,{tone:"info",children:`${r.length} fields`})]}),e.jsx(le,{columns:{xs:1,sm:2,md:3},gap:"300",children:r.map(c=>{const m=`${t}::${c.field_name}`,C=B[m]??"",G=c.mapping_type==="shopify_field"&&c.resolved&&C===c.resolved,x=c.mapping_type==="constant"&&C===c.resolved,L=G?"Auto-filled from Shopify":x?"Default value":c.mapping_type==="edit_in_grid"?"Manual entry":void 0;return e.jsx(je,{label:ie(c.field_name),value:C,onChange:Ie=>Y(t,c.field_name,Ie),autoComplete:"off",helpText:L,labelAction:G?{content:"Reset",onAction:()=>Y(t,c.field_name,c.resolved)}:void 0},m)})}),t!=="payment"&&e.jsx(T,{})]},t))]})})})}),e.jsx(P,{children:e.jsx(P.Section,{children:e.jsx(D,{children:e.jsxs(u,{gap:"300",children:[e.jsxs(p,{gap:"200",blockAlign:"center",children:[e.jsx($,{background:"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(H,{source:ve})}),e.jsx(a,{variant:"headingMd",as:"h2",children:"Sync history"})]}),e.jsx(T,{}),g.length===0?e.jsx(a,{tone:"subdued",as:"p",children:"No sync activity recorded yet."}):e.jsx(u,{gap:"200",children:g.map(t=>e.jsxs(p,{align:"space-between",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",as:"span",children:t.label}),e.jsx(a,{variant:"bodySm",as:"span",children:t.value})]},t.label))})]})})})})]})]})},Ve=()=>{const s=ye(),o=fe(),{addNotification:j}=be(),f=Ce(),[v,J]=d.useState(""),[b,i]=d.useState("all"),[w,z]=d.useState(0),[S,I]=d.useState([]),N=50;d.useEffect(()=>{z(0)},[v,b]);const K=d.useMemo(()=>{if(!(b==="all"||b==="missing"))return b==="active"?"active,synced":b},[b]),{data:M,isLoading:Q,error:B}=me({limit:N,offset:w,search:v||void 0,status:K}),k=d.useMemo(()=>(M?.data??[]).map(Se),[M]),O=d.useMemo(()=>b!=="missing"?k:k.filter(n=>!n.ebayListingId),[k,b]),W=M?.total??0,F=d.useMemo(()=>{const n=k.filter(y=>V(y).label==="Active").length,l=k.filter(y=>!y.ebayListingId).length,g=k.filter(y=>V(y).label==="Error").length,h=k.filter(y=>V(y).label==="Draft").length;return{active:n,missing:l,errorCount:g,draft:h}},[k]),_=d.useMemo(()=>O.map(n=>n.shopifyProductId),[O]),X=_.length>0&&_.every(n=>S.includes(n)),R=d.useCallback(n=>{I(n?l=>Array.from(new Set([...l,..._])):l=>l.filter(g=>!_.includes(g)))},[_]),Y=d.useCallback(n=>{I(l=>l.includes(n)?l.filter(g=>g!==n):[...l,n])},[]),Z=te({mutationFn:n=>Promise.all(n.map(l=>U.post(`/sync/products/${l}/end`))),onSuccess:(n,l)=>{o.invalidateQueries({queryKey:["listings"]}),j({type:"success",title:`${l.length} listings ended`,autoClose:4e3}),I([])},onError:n=>{j({type:"error",title:"Bulk end failed",message:n instanceof Error?n.message:"Unknown error"})}}),ee=te({mutationFn:n=>Promise.all(n.map(l=>U.put(`/sync/products/${l}`))),onSuccess:(n,l)=>{o.invalidateQueries({queryKey:["listings"]}),j({type:"success",title:`${l.length} listings relisted`,autoClose:4e3}),I([])},onError:n=>{j({type:"error",title:"Bulk relist failed",message:n instanceof Error?n.message:"Unknown error"})}}),ie=O.map((n,l)=>{const g=V(n),h=n.shopifyTitle??`Shopify product ${n.shopifyProductId}`,y=ae(n.ebayListingId);return e.jsxs(A.Row,{id:n.shopifyProductId,position:l,selected:S.includes(n.shopifyProductId),onClick:()=>s(`/ebay/listings/${n.shopifyProductId}`),children:[e.jsx(A.Cell,{children:e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",as:"p",children:h}),n.shopifySku&&e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"p",children:["SKU: ",n.shopifySku]})]})}),e.jsx(A.Cell,{children:e.jsxs(u,{gap:"100",children:[e.jsx(a,{variant:"bodyMd",as:"p",children:n.ebayListingId??"No listing linked"}),e.jsxs(a,{variant:"bodySm",tone:"subdued",as:"p",children:["Inv: ",n.ebayInventoryItemId??"—"]})]})}),e.jsx(A.Cell,{children:e.jsx(q,{tone:g.tone,children:g.label})}),e.jsx(A.Cell,{children:e.jsx(a,{variant:"bodyMd",as:"p",children:de(n.originalPrice??null)})}),e.jsx(A.Cell,{children:e.jsx(a,{variant:"bodySm",tone:"subdued",as:"p",children:Oe(n.updatedAt)})}),e.jsx(A.Cell,{children:y?e.jsx(q,{tone:"info",children:"Draft"}):e.jsx(E,{size:"micro",icon:ce,onClick:()=>n.ebayListingId&&window.open(`https://www.ebay.com/itm/${n.ebayListingId}`,"_blank"),disabled:!n.ebayListingId,children:"View"})})]},n.id)});return e.jsx(xe,{title:"Products & Listings",subtitle:"Shopify catalog synced to eBay listings",primaryAction:{content:"Sync all products",onAction:()=>f.mutate([]),loading:f.isPending},fullWidth:!0,children:e.jsxs(u,{gap:"500",children:[e.jsxs(le,{columns:{xs:2,sm:4},gap:"300",children:[e.jsx(ne,{label:"Active",value:F.active,icon:Me,tone:"success"}),e.jsx(ne,{label:"Missing",value:F.missing,icon:ge,tone:"critical"}),e.jsx(ne,{label:"Draft",value:F.draft,icon:ve,tone:"info"}),e.jsx(ne,{label:"Errors",value:F.errorCount,icon:ge,tone:"warning"})]}),e.jsx(D,{children:e.jsxs(u,{gap:"300",children:[e.jsxs(p,{gap:"300",align:"space-between",blockAlign:"end",children:[e.jsx($,{minWidth:"280px",children:e.jsx(je,{label:"Search",labelHidden:!0,placeholder:"Search by title, SKU, or eBay listing ID",value:v,onChange:J,prefix:e.jsx(H,{source:Be}),clearButton:!0,onClearButtonClick:()=>J(""),autoComplete:"off"})}),e.jsx(p,{gap:"200",wrap:!0,children:["all","active","missing","error","inactive","pending"].map(n=>e.jsx(E,{pressed:b===n,onClick:()=>i(n),children:n.charAt(0).toUpperCase()+n.slice(1)},n))})]}),S.length>0&&e.jsx(D,{padding:"200",children:e.jsxs(p,{align:"space-between",gap:"300",blockAlign:"center",children:[e.jsxs(a,{variant:"bodyMd",as:"p",fontWeight:"medium",children:[S.length," selected"]}),e.jsxs($e,{children:[e.jsx(E,{icon:De,onClick:()=>ee.mutate(S),loading:ee.isPending,children:"Bulk relist"}),e.jsx(E,{icon:Ee,tone:"critical",onClick:()=>Z.mutate(S),loading:Z.isPending,children:"Bulk end"})]})]})}),B&&e.jsx(oe,{tone:"critical",title:"Unable to load listings",children:e.jsx(a,{as:"p",children:B instanceof Error?B.message:"Something went wrong."})}),e.jsx(T,{}),Q?e.jsx($,{padding:"800",children:e.jsx(p,{align:"center",children:e.jsx(re,{accessibilityLabel:"Loading listings",size:"large"})})}):e.jsx(A,{resourceName:{singular:"listing",plural:"listings"},itemCount:O.length,selectedItemsCount:S.length,onSelectionChange:(n,l,g)=>{n==="all"?R(!X):g&&typeof g=="string"&&Y(g)},headings:[{title:"Product"},{title:"eBay listing"},{title:"Status"},{title:"Price"},{title:"Last updated"},{title:"Actions"}],children:ie})]})}),e.jsx(p,{align:"center",children:e.jsx(Ne,{hasPrevious:w>0,onPrevious:()=>z(Math.max(0,w-N)),hasNext:w+N<W,onNext:()=>z(w+N)})})]})})};export{qe as ListingDetail,Ve as default};
