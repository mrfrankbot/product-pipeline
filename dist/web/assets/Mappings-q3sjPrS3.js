import{r as s,j as e}from"./vendor-react-DzgxJkbp.js";import{b as oe,v as ce,u as de,f as ue}from"./index-DJAOEm-v.js";import{P as L,C as Q,b as m,I as _,x as pe,B,a as p,T as o,o as ge,a6 as he,a7 as fe,a8 as me,c as $,n as be,E as P,J as xe,a0 as q,D as ve,$ as je,e as Z,H as g,a9 as ye,U as _e,V as I,aa as X,ab as Se}from"./vendor-polaris-o1SQP_xq.js";import"./vendor-query-BeqrpgNA.js";const Ce=[{label:"Select a field",value:""},{title:"Product fields",options:[{label:"Title",value:"title"},{label:"Description (body_html)",value:"body_html"},{label:"Vendor",value:"vendor"},{label:"Product type",value:"product_type"},{label:"Tags",value:"tags"},{label:"Handle",value:"handle"},{label:"Status",value:"status"}]},{title:"Variant fields",options:[{label:"SKU",value:"variants[0].sku"},{label:"Barcode",value:"variants[0].barcode"},{label:"Price",value:"variants[0].price"},{label:"Compare at price",value:"variants[0].compare_at_price"},{label:"Weight",value:"variants[0].weight"},{label:"Inventory quantity",value:"variants[0].inventory_quantity"}]},{title:"Metafields",options:[{label:"Condition",value:"metafields.condition"},{label:"Brand",value:"metafields.brand"}]},{title:"Images",options:[{label:"Main image URL",value:"images[0].src"},{label:"Featured image URL",value:"image.src"}]}],Me=[{label:"Use Shopify field",value:"shopify_field"},{label:"Set constant value",value:"constant"},{label:"Edit per product",value:"edit_in_grid"},{label:"Custom formula",value:"formula"}],S={sales:["sku","price"],listing:["title","description","condition","category"],payment:["accepted_payments"],shipping:["shipping_cost","handling_time"]},A={sales:"Sales",listing:"Listing",payment:"Payment",shipping:"Shipping"},we=[{label:"All fields",value:"all"},{label:"Required only",value:"required"},{label:"Unmapped required",value:"unmapped"},{label:"Disabled",value:"disabled"}],Ee=r=>r.replace(/_/g," ").replace(/\b\w/g,k=>k.toUpperCase()),D=r=>{if(!r||!r.is_enabled)return!1;switch(r.mapping_type){case"shopify_field":return!!r.source_value;case"constant":case"formula":return!!r.target_value;case"edit_in_grid":return!0;default:return!1}},Ue=()=>{const{data:r,isLoading:k,error:H,refetch:N}=oe(),T=ce(),{setUnsavedMappingChange:W,removeUnsavedMappingChange:V,clearUnsavedMappingChanges:ee,setSavingMappings:C}=de(),[z,ae]=s.useState(0),[U,J]=s.useState(""),[b,te]=s.useState("all"),[c,Y]=s.useState(new Map),[G,h]=s.useState(null),[ne,M]=s.useState(!1),[le,w]=s.useState(!1),[x,K]=s.useState(null),v=s.useRef(null),j=s.useMemo(()=>Object.keys(A),[]),f=s.useMemo(()=>{const a=new Map;return r&&j.forEach(n=>{r[n]?.forEach(t=>{a.set(`${n}:${t.field_name}`,t)})}),a},[r,j]),E=s.useCallback(a=>{const n=`${a.category}:${a.field_name}`;return{...a,...c.get(n)??{}}},[c]),y=s.useCallback((a,n)=>{const t=`${a.category}:${a.field_name}`;Y(i=>{const l=new Map(i);return l.set(t,{...l.get(t)??{},...n}),l}),W(t,n)},[W]),O=s.useCallback(async a=>{if(a.length===0)return;C(!0);const n=a.map(t=>{const i=f.get(t),l=c.get(t)??{};return i?{...i,...l}:null}).filter(Boolean);n.length!==0&&T.mutate(n,{onSuccess:()=>{Y(t=>{const i=new Map(t);return a.forEach(l=>i.delete(l)),i}),a.forEach(t=>V(t)),C(!1),h("Mappings saved")},onError:t=>{C(!1),h(t instanceof Error?t.message:"Failed to save mappings")}})},[T,f,c,V,C]);s.useEffect(()=>{if(c.size!==0)return v.current&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{O(Array.from(c.keys()))},800),()=>{v.current&&window.clearTimeout(v.current)}},[c,O]);const se=s.useMemo(()=>j.map(a=>{const t=(S[a]??[]).reduce((i,l)=>i+(D(f.get(`${a}:${l}`))?0:1),0);return{id:a,content:A[a],accessibilityLabel:`${A[a]} mappings`,badge:t>0?String(t):void 0}}),[j,f]),d=j[z],F=s.useMemo(()=>(r?.[d]??[]).filter(n=>n.field_name.toLowerCase().includes(U.toLowerCase())?b==="required"?(S[d]??[]).includes(n.field_name):b==="disabled"?!E(n).is_enabled:b==="unmapped"?(S[d]??[]).includes(n.field_name)&&!D(E(n)):!0:!1),[d,r,b,E,U]),R=s.useMemo(()=>(S[d]??[]).reduce((n,t)=>n+(D(f.get(`${d}:${t}`))?0:1),0),[d,f]),ie=async()=>{try{const a=await fetch("/api/mappings/export");if(!a.ok)throw new Error("Export failed");const n=await a.blob(),t=window.URL.createObjectURL(n),i=document.createElement("a");i.href=t,i.download=`mappings-export-${new Date().toISOString().split("T")[0]}.json`,i.click(),window.URL.revokeObjectURL(t),w(!1)}catch(a){h(a instanceof Error?a.message:"Export failed")}},re=async()=>{if(x)try{const a=await x.text(),n=JSON.parse(a),t=Array.isArray(n)?n:n.mappings??[];await ue.post("/mappings/import",{mappings:t}),M(!1),K(null),ee(),N(),h("Mappings imported")}catch(a){h(a instanceof Error?a.message:"Import failed")}};return k?e.jsx(L,{title:"Field Mappings",fullWidth:!0,children:e.jsx(Q,{children:e.jsx(m,{padding:"600",children:e.jsx(_,{align:"center",children:e.jsx(pe,{accessibilityLabel:"Loading mappings",size:"large"})})})})}):H?e.jsx(L,{title:"Field Mappings",fullWidth:!0,children:e.jsx(B,{tone:"critical",title:"Failed to load mappings",children:e.jsxs(p,{gap:"200",children:[e.jsx(o,{as:"p",children:H.message}),e.jsx(ge,{onClick:()=>N(),children:"Try again"})]})})}):e.jsxs(L,{title:"Field Mappings",subtitle:"Configure how Shopify fields map to eBay listing attributes",fullWidth:!0,primaryAction:{content:"Save changes",icon:me,onAction:()=>O(Array.from(c.keys())),disabled:c.size===0,loading:T.isPending},secondaryActions:[{content:"Export",icon:he,onAction:()=>w(!0)},{content:"Import",icon:fe,onAction:()=>M(!0)}],children:[e.jsxs(p,{gap:"500",children:[c.size>0&&e.jsx(B,{tone:"info",title:"Auto-save is enabled",children:e.jsx(o,{as:"p",children:"Changes are saved automatically after a short delay."})}),e.jsx(Q,{children:e.jsxs(p,{gap:"400",children:[e.jsxs(_,{gap:"200",blockAlign:"center",children:[e.jsx(m,{background:"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx($,{source:be})}),e.jsx(o,{variant:"headingMd",as:"h2",children:"Mapping Configuration"})]}),e.jsxs(_,{gap:"400",align:"space-between",children:[e.jsx(m,{minWidth:"280px",children:e.jsx(P,{label:"Search fields",labelHidden:!0,value:U,onChange:J,prefix:e.jsx($,{source:xe}),placeholder:"Search fields",clearButton:!0,onClearButtonClick:()=>J(""),autoComplete:"off"})}),e.jsx(m,{minWidth:"220px",children:e.jsx(q,{label:"Filter",labelHidden:!0,options:we,value:b,onChange:te})})]}),e.jsx(ve,{}),e.jsx(je,{tabs:se,selected:z,onSelect:ae,children:e.jsx(m,{paddingBlockStart:"400",children:e.jsxs(p,{gap:"300",children:[e.jsxs(_,{gap:"200",align:"space-between",blockAlign:"center",children:[e.jsxs(p,{gap:"100",children:[e.jsxs(o,{variant:"headingMd",as:"h2",children:[A[d]," mappings"]}),e.jsxs(o,{as:"p",tone:"subdued",variant:"bodySm",children:[F.length," fields Â· ",R," required unmapped"]})]}),e.jsx(Z,{tone:R>0?"critical":"success",children:R>0?"Action needed":"Complete"})]}),e.jsx(g,{resourceName:{singular:"mapping",plural:"mappings"},itemCount:F.length,selectable:!1,headings:[{title:"Field name"},{title:""},{title:"Mapping type"},{title:"Configuration"},{title:"Enabled"}],children:F.map((a,n)=>{const t=E(a),i=(S[a.category]??[]).includes(a.field_name);return e.jsxs(g.Row,{id:`${a.category}-${a.field_name}`,position:n,children:[e.jsx(g.Cell,{children:e.jsxs(_,{gap:"200",blockAlign:"center",children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:Ee(a.field_name)}),i&&e.jsx(Z,{tone:"critical",size:"small",children:"Required"})]})}),e.jsx(g.Cell,{children:e.jsx($,{source:ye,tone:"subdued"})}),e.jsx(g.Cell,{children:e.jsx(q,{label:"Mapping type",labelHidden:!0,options:Me,value:t.mapping_type,onChange:l=>{const u={mapping_type:l};l==="shopify_field"?(u.source_value="",u.target_value=null):l==="constant"||l==="formula"?(u.target_value="",u.source_value=null):(u.source_value=null,u.target_value=null),y(a,u)}})}),e.jsx(g.Cell,{children:e.jsxs(m,{minWidth:"220px",children:[t.mapping_type==="shopify_field"&&e.jsx(q,{label:"Shopify field",labelHidden:!0,options:Ce,value:t.source_value??"",onChange:l=>y(a,{source_value:l})}),t.mapping_type==="constant"&&e.jsx(P,{label:"Constant value",labelHidden:!0,value:t.target_value??"",onChange:l=>y(a,{target_value:l}),placeholder:"Enter value",autoComplete:"off"}),t.mapping_type==="formula"&&e.jsx(P,{label:"Formula",labelHidden:!0,value:t.target_value??"",onChange:l=>y(a,{target_value:l}),placeholder:"e.g. {{title}} - {{sku}}",helpText:"Use {{field}} tokens for Shopify fields",autoComplete:"off"}),t.mapping_type==="edit_in_grid"&&e.jsx(o,{as:"p",tone:"subdued",variant:"bodySm",children:"Edit per product in the listings grid."})]})}),e.jsx(g.Cell,{children:e.jsx(_e,{label:"Enabled",labelHidden:!0,checked:t.is_enabled,onChange:l=>y(a,{is_enabled:l})})})]},`${a.category}-${a.field_name}`)})})]})})})]})})]}),e.jsx(I,{open:le,onClose:()=>w(!1),title:"Export mappings",primaryAction:{content:"Export",onAction:ie},secondaryActions:[{content:"Cancel",onAction:()=>w(!1)}],children:e.jsx(I.Section,{children:e.jsxs(p,{gap:"200",children:[e.jsx(o,{as:"p",children:"Download all mappings as a JSON file."}),e.jsx(o,{as:"p",tone:"subdued",variant:"bodySm",children:"Use this export to back up or move mappings between stores."})]})})}),e.jsx(I,{open:ne,onClose:()=>M(!1),title:"Import mappings",primaryAction:{content:"Import",onAction:re,disabled:!x},secondaryActions:[{content:"Cancel",onAction:()=>M(!1)}],children:e.jsx(I.Section,{children:e.jsxs(p,{gap:"300",children:[e.jsx(o,{as:"p",children:"Upload a JSON export to replace existing mappings."}),e.jsx(X,{accept:"application/json",onDrop:a=>K(a[0]??null),allowMultiple:!1,children:e.jsx(X.FileUpload,{actionTitle:"Add JSON file",actionHint:"or drop a file"})}),x&&e.jsx(B,{tone:"warning",title:"Import will overwrite all mappings",children:e.jsxs(o,{as:"p",children:["Selected file: ",x.name]})})]})})}),G&&e.jsx(Se,{content:G,onDismiss:()=>h(null)})]})};export{Ue as default};
