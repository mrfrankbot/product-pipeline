import{r as i,j as e,h as hs,u as Ue,R as ke}from"./vendor-react-DzgxJkbp.js";import{a as Ke,u as oe,b as te}from"./vendor-query-BeqrpgNA.js";import{g as ye,X as _e,C as gs,h as xs,u as Re,f as $,i as ms,j as fs,k as ys,l as bs,m as js,a as vs}from"./index-DJAOEm-v.js";import{C as T,a as x,I as r,T as n,e as k,D as X,E as Le,o as I,R as Ss,b as O,B as ne,U as Be,K as We,y as xe,V as Te,W as ws,X as ks,x as me,P as He,Y as Ce,L as Pe,Z as Cs,_ as Ps,H as re,$ as As,c as Is,J as Rs,Q as Ls}from"./vendor-polaris-o1SQP_xq.js";import{P as $s,L as Ds,I as Ms,T as Fs}from"./TemplateManager-BQR2aI17.js";import{P as zs}from"./ProductPhotoEditor-CThSZZWJ.js";const Es=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],_s=ye("pencil",Es);const Bs=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],fe=ye("refresh-cw",Bs);const Ts=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ns=ye("rotate-ccw",Ts);const qs=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Us=ye("zoom-in",qs),Ks=[{hex:"#FFFFFF",label:"White"},{hex:"#F5F5F5",label:"Light Gray"},{hex:"#000000",label:"Black"},{hex:"#E8F0FE",label:"Light Blue"},{hex:"#FFF9E6",label:"Cream"},{hex:"#F0F0F0",label:"Silver"}],Qe=({selectedImageUrl:s,onReprocess:h,onReprocessAll:p,onParamsChange:a,reprocessing:j,reprocessingAll:D,previewUrl:P,imageCount:A=0,hideActionButtons:y=!1})=>{const[v,E]=i.useState("#FFFFFF"),[C,S]=i.useState(10),[f,z]=i.useState(!0),[g,M]=i.useState(""),R=i.useCallback(()=>({background:v,padding:C/100,shadow:f}),[v,C,f]);i.useEffect(()=>{a&&a(R())},[a,R]);const K=i.useCallback(()=>{s&&h(s,R())},[s,h,R]),_=i.useCallback(()=>{p(R())},[p,R]),W=i.useCallback(()=>{const l=g.startsWith("#")?g:`#${g}`;/^#[0-9A-Fa-f]{6}$/.test(l)&&(E(l),M(""))},[g]);return e.jsx(T,{children:e.jsxs(x,{gap:"400",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(x,{gap:"050",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Reprocessing Controls"}),e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:"Adjust PhotoRoom settings and reprocess images"})]}),e.jsx(k,{tone:"info",children:"PhotoRoom"})]}),e.jsx(X,{}),e.jsxs(x,{gap:"200",children:[e.jsxs(r,{gap:"100",blockAlign:"center",children:[e.jsx($s,{size:16,color:"#6b7280"}),e.jsx(n,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:"Background Color"})]}),e.jsx(r,{gap:"200",wrap:!0,children:Ks.map(l=>e.jsx("button",{onClick:()=>E(l.hex),title:l.label,style:{width:36,height:36,borderRadius:8,border:v===l.hex?"2px solid #2563eb":"2px solid #e5e7eb",backgroundColor:l.hex,cursor:"pointer",padding:0,position:"relative"},children:v===l.hex&&e.jsx("span",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",color:l.hex==="#000000"?"#fff":"#2563eb",fontWeight:700,fontSize:16},children:"‚úì"})},l.hex))}),e.jsxs(r,{gap:"200",blockAlign:"end",children:[e.jsx("div",{style:{flex:1,maxWidth:160},children:e.jsx(Le,{label:"",placeholder:"#AABBCC",value:g,onChange:M,autoComplete:"off",connectedRight:e.jsx(I,{size:"slim",onClick:W,children:"Apply"})})}),e.jsx("div",{style:{width:36,height:36,borderRadius:8,border:"2px solid #e5e7eb",backgroundColor:v}}),e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:v})]})]}),e.jsx(X,{}),e.jsxs(x,{gap:"200",children:[e.jsxs(r,{gap:"100",blockAlign:"center",children:[e.jsx(Ds,{size:16,color:"#6b7280"}),e.jsx(n,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:"Padding / White Space"}),e.jsxs(n,{variant:"bodySm",tone:"subdued",as:"span",children:[C,"%"]})]}),e.jsx(Ss,{label:"",value:C,min:0,max:50,step:1,onChange:l=>S(typeof l=="number"?l:l[0]),output:!0}),e.jsx(r,{gap:"200",children:[0,5,10,20,30].map(l=>e.jsx(I,{size:"slim",variant:C===l?"primary":"secondary",onClick:()=>S(l),children:`${l}%`},l))})]}),e.jsx(X,{}),e.jsxs(x,{gap:"200",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"100",blockAlign:"center",children:[e.jsx(Ms,{size:16,color:"#6b7280"}),e.jsx(n,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:"Drop Shadow"})]}),e.jsx("button",{onClick:()=>z(!f),style:{position:"relative",width:44,height:24,borderRadius:12,border:"none",backgroundColor:f?"#2563eb":"#d1d5db",cursor:"pointer",transition:"background-color 200ms",padding:0},children:e.jsx("span",{style:{position:"absolute",top:2,left:f?22:2,width:20,height:20,borderRadius:"50%",backgroundColor:"#fff",transition:"left 200ms",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}})})]}),e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:f?"AI soft shadow enabled ‚Äî adds a natural drop shadow under the product":"Shadow disabled ‚Äî clean cutout on solid background"})]}),e.jsx(X,{}),P&&e.jsxs(x,{gap:"200",children:[e.jsx(n,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:"Preview"}),e.jsx("div",{style:{background:"#f9fafb",borderRadius:8,padding:8,textAlign:"center"},children:e.jsx("img",{src:P,alt:"Processing preview",style:{maxWidth:"100%",maxHeight:240,objectFit:"contain",borderRadius:6}})}),e.jsx(X,{})]}),e.jsx(O,{padding:"200",background:"bg-surface-secondary",borderRadius:"200",children:e.jsxs(r,{gap:"300",wrap:!0,children:[e.jsxs(r,{gap:"100",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"BG:"}),e.jsx("div",{style:{width:14,height:14,borderRadius:3,border:"1px solid #e5e7eb",backgroundColor:v,display:"inline-block"}}),e.jsx(n,{variant:"bodySm",as:"span",children:v})]}),e.jsxs(r,{gap:"100",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Padding:"}),e.jsxs(n,{variant:"bodySm",as:"span",children:[C,"%"]})]}),e.jsxs(r,{gap:"100",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Shadow:"}),e.jsx(k,{tone:f?"success":void 0,children:f?"On":"Off"})]})]})}),!y&&e.jsxs(e.Fragment,{children:[e.jsxs(r,{gap:"200",children:[e.jsx(I,{variant:"primary",icon:e.jsx(fe,{size:16}),onClick:K,loading:j,disabled:!s||D,children:s?"Reprocess Image":"Select an image first"}),e.jsx(I,{icon:e.jsx(fe,{size:16}),onClick:_,loading:D,disabled:A===0||j,children:`Reprocess All (${A})`})]}),!s&&e.jsx(ne,{tone:"info",children:e.jsx("p",{children:"Click an image in the gallery above to select it for individual reprocessing."})})]})]})})},Ws="https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png",Hs=({photos:s,loading:h=!1,onDeleteSingle:p,onDeleteBulk:a,onEditPhotos:j,onSelectionChange:D,onImageClick:P,onEditPhoto:A})=>{const[y,v]=i.useState(new Set),E=i.useCallback(d=>{v(d),D?.(Array.from(d))},[D]),[C,S]=i.useState(!1),[f,z]=i.useState([]),[g,M]=i.useState(null),R=i.useCallback(()=>{y.size===s.length?E(new Set):E(new Set(s.map(d=>d.id)))},[s,y.size,E]),K=i.useCallback(d=>{const F=new Set(y);F.has(d)?F.delete(d):F.add(d),E(F)},[y,E]),_=i.useCallback(d=>{z([d]),S(!0)},[]),W=i.useCallback(()=>{z(Array.from(y)),S(!0)},[y]),l=i.useCallback(()=>{f.length===1?p(f[0]):a(f),S(!1),E(new Set),z([])},[f,p,a]),U=i.useCallback(()=>{y.size===0?j(s.map(d=>d.id)):j(Array.from(y))},[y,s,j]),ie=i.useCallback((d,F)=>{M({photo:d,index:F}),P?.(d,F)},[P]),H=i.useCallback(()=>{M(null)},[]),Y=i.useCallback(d=>{if(!g)return;const F=g.index;let L;d==="prev"?L=F===0?s.length-1:F-1:L=F===s.length-1?0:F+1,M({photo:s[L],index:L})},[g,s]);if(h)return e.jsx(T,{children:e.jsx(O,{padding:"400",children:e.jsx(r,{align:"center",children:e.jsx(n,{tone:"subdued",as:"p",children:"Loading photos..."})})})});const N=y.size===s.length&&s.length>0,Z=y.size>0,V=N?!0:Z?"indeterminate":!1;return e.jsxs(e.Fragment,{children:[e.jsx(T,{children:e.jsxs(x,{gap:"400",children:[e.jsx(r,{align:"space-between",blockAlign:"center",children:e.jsxs(x,{gap:"050",children:[e.jsxs(r,{gap:"200",blockAlign:"center",children:[e.jsxs(n,{variant:"headingMd",as:"h2",children:["Photos on Shopify (",s.length,")"]}),s.length>0&&e.jsx(Be,{label:"Select All",checked:V,onChange:R})]}),e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:"These are the images currently live on your Shopify product"})]})}),Z&&e.jsx(O,{padding:"200",background:"bg-surface-secondary",borderRadius:"200",children:e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(n,{variant:"bodySm",as:"span",children:[y.size," photo",y.size!==1?"s":""," selected"]}),e.jsxs(We,{children:[e.jsx(I,{size:"slim",tone:"critical",onClick:W,children:"Delete Selected"}),e.jsx(I,{size:"slim",variant:"primary",onClick:U,children:"Edit with PhotoRoom"})]})]})}),s.length===0?e.jsx(O,{padding:"800",children:e.jsxs(x,{gap:"200",inlineAlign:"center",children:[e.jsx(n,{tone:"subdued",as:"p",alignment:"center",children:"No photos found on this Shopify product."}),e.jsx(n,{tone:"subdued",as:"p",alignment:"center",variant:"bodySm",children:"Add photos in Shopify admin, then refresh this page."})]})}):e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(200px, 1fr))",gap:"12px"},children:s.map((d,F)=>e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("div",{style:{border:y.has(d.id)?"2px solid #2563eb":"2px solid transparent",borderRadius:"8px",overflow:"hidden",position:"relative"},children:[e.jsx("div",{onClick:()=>ie(d,F),style:{cursor:"pointer"},children:e.jsx(xe,{size:"large",source:d.src||Ws,alt:d.alt||`Product image ${d.position}`})}),e.jsx("button",{onClick:L=>{L.stopPropagation(),_(d.id)},style:{position:"absolute",top:"6px",right:"6px",background:"rgba(0, 0, 0, 0.7)",border:"none",borderRadius:"50%",padding:"4px",cursor:"pointer",color:"white",display:"flex",alignItems:"center",justifyContent:"center"},title:"Delete this photo",children:e.jsx(_e,{size:16})}),e.jsx("div",{style:{position:"absolute",top:"6px",left:"6px"},children:e.jsx(Be,{label:"",checked:y.has(d.id),onChange:()=>K(d.id)})}),A&&e.jsx("button",{onClick:L=>{L.stopPropagation(),A(d,F)},style:{position:"absolute",bottom:"6px",left:"6px",background:"rgba(0, 0, 0, 0.7)",border:"none",borderRadius:"50%",padding:"4px",cursor:"pointer",color:"white",display:"flex",alignItems:"center",justifyContent:"center"},title:"Edit photo (rotate/scale/reposition)",children:e.jsx(_s,{size:16})}),e.jsx("button",{onClick:L=>{L.stopPropagation(),ie(d,F)},style:{position:"absolute",bottom:"6px",right:"6px",background:"rgba(0, 0, 0, 0.7)",border:"none",borderRadius:"50%",padding:"4px",cursor:"pointer",color:"white",display:"flex",alignItems:"center",justifyContent:"center"},title:"View full size",children:e.jsx(Us,{size:16})})]}),e.jsx(O,{paddingBlockStart:"100",children:e.jsxs(n,{variant:"bodySm",tone:"subdued",as:"p",alignment:"center",children:["Position ",d.position]})})]},d.id))})]})}),e.jsx(Te,{open:C,onClose:()=>S(!1),title:`Delete ${f.length} photo${f.length!==1?"s":""}?`,primaryAction:{content:"Delete",destructive:!0,onAction:l},secondaryActions:[{content:"Cancel",onAction:()=>S(!1)}],children:e.jsx(Te.Section,{children:e.jsxs(n,{as:"p",children:["Delete ",f.length," photo",f.length!==1?"s":""," from Shopify? This action cannot be undone."]})})}),g&&e.jsxs("div",{style:{position:"fixed",inset:0,zIndex:999999,backgroundColor:"rgba(0,0,0,0.9)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:H,children:[e.jsx("button",{onClick:H,style:{position:"absolute",top:"16px",right:"16px",background:"rgba(255,255,255,0.1)",border:"none",borderRadius:"50%",padding:"8px",cursor:"pointer",color:"#fff"},children:e.jsx(_e,{size:24})}),s.length>1&&e.jsx("button",{onClick:d=>{d.stopPropagation(),Y("prev")},style:{position:"absolute",left:"16px",top:"50%",transform:"translateY(-50%)",background:"rgba(255,255,255,0.1)",border:"none",borderRadius:"50%",padding:"12px",cursor:"pointer",color:"#fff"},children:"‚Üê"}),e.jsx("img",{src:g.photo.src,alt:g.photo.alt||"Product image",style:{maxWidth:"90vw",maxHeight:"90vh",objectFit:"contain",borderRadius:"8px"},onClick:d=>d.stopPropagation()}),s.length>1&&e.jsx("button",{onClick:d=>{d.stopPropagation(),Y("next")},style:{position:"absolute",right:"16px",top:"50%",transform:"translateY(-50%)",background:"rgba(255,255,255,0.1)",border:"none",borderRadius:"50%",padding:"12px",cursor:"pointer",color:"#fff"},children:"‚Üí"}),e.jsxs("div",{style:{position:"absolute",bottom:"16px",left:"50%",transform:"translateX(-50%)",color:"#fff",fontSize:"14px",opacity:.8},children:[g.index+1," / ",s.length]})]})]})},Qs="https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png",Os=({photos:s,selectedPhotoIds:h,isOpen:p,onToggle:a,onProcessSingle:j,onProcessSelected:D,onProcessAll:P,onRevertToOriginal:A,processing:y=!1})=>{const[v,E]=i.useState({background:"#FFFFFF",padding:.1,shadow:!0}),C=s.filter(l=>h.includes(l.id)),S=h.length>0,f=s.length,z=s.filter(l=>l.processing).length,g=s.filter(l=>l.processed).length,M=s.filter(l=>l.error).length,R=i.useCallback(async()=>{h.length!==0&&await D(h,v)},[h,v,D]),K=i.useCallback(async()=>{await P(v)},[v,P]),_=z>0,W=_?(g+M)/(g+M+z)*100:100;return e.jsx(T,{children:e.jsxs(x,{gap:"400",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"200",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Edit Photos with PhotoRoom"}),S&&e.jsx(k,{tone:"info",children:`${h.length} selected`})]}),e.jsxs(I,{onClick:a,icon:p?e.jsx(gs,{size:16}):e.jsx(xs,{size:16}),variant:"plain",children:[p?"Hide":"Show"," Editor"]})]}),e.jsx(ws,{id:"edit-photos-collapsible",open:p,children:e.jsxs(x,{gap:"400",children:[_&&e.jsx(O,{padding:"200",background:"bg-surface-secondary",borderRadius:"200",children:e.jsxs(x,{gap:"200",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(n,{variant:"bodySm",as:"span",children:["Processing ",z," photo",z!==1?"s":"","..."]}),e.jsxs(n,{variant:"bodySm",tone:"subdued",as:"span",children:[g+M," / ",g+M+z]})]}),e.jsx(ks,{progress:Math.round(W)})]})}),e.jsx(Qe,{selectedImageUrl:null,onReprocess:(l,U)=>{E(U)},onReprocessAll:l=>E(l),onParamsChange:l=>E(l),reprocessing:!1,reprocessingAll:y,imageCount:f,hideActionButtons:!0}),e.jsx(r,{gap:"200",align:"space-between",children:e.jsxs(x,{gap:"200",children:[e.jsx(n,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:"Apply Processing:"}),e.jsxs(r,{gap:"200",children:[e.jsxs(I,{variant:"primary",icon:e.jsx(fe,{size:16}),onClick:K,loading:y,disabled:f===0,children:["Apply to All Photos (",f.toString(),")"]}),e.jsxs(I,{variant:"secondary",icon:e.jsx(fe,{size:16}),onClick:R,loading:y,disabled:!S,children:["Apply to Selected (",h.length.toString(),")"]})]})]})}),e.jsx(X,{}),s.length>0&&e.jsxs(x,{gap:"300",children:[e.jsxs(n,{variant:"bodyMd",fontWeight:"semibold",as:"span",children:["Preview (",S?C.length:s.length," photo",(S?C.length:s.length)!==1?"s":"","):"]}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"16px",maxHeight:"400px",overflowY:"auto"},children:(S?C:s).map(l=>e.jsx("div",{children:e.jsx(T,{padding:"200",children:e.jsxs(x,{gap:"200",children:[e.jsxs(r,{gap:"200",wrap:!1,children:[e.jsxs("div",{style:{flex:1},children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:"Before"}),e.jsx(xe,{size:"small",source:l.originalUrl||Qs,alt:"Before processing"})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:"After"}),l.processing?e.jsx("div",{style:{width:"80px",height:"80px",display:"flex",alignItems:"center",justifyContent:"center",background:"#f3f4f6",borderRadius:"6px"},children:e.jsx(me,{accessibilityLabel:"Processing",size:"small"})}):l.processedUrl?e.jsx(xe,{size:"small",source:l.processedUrl,alt:"After processing"}):e.jsx("div",{style:{width:"80px",height:"80px",display:"flex",alignItems:"center",justifyContent:"center",background:"#f3f4f6",borderRadius:"6px",color:"#9ca3af",fontSize:"12px",textAlign:"center"},children:"Not processed"})]})]}),e.jsxs(r,{align:"space-between",blockAlign:"center",children:[l.processing?e.jsx(k,{tone:"warning",children:"Processing..."}):l.error?e.jsx(k,{tone:"critical",children:"Error"}):l.processed?e.jsx(k,{tone:"success",children:"Processed"}):e.jsx(k,{children:"Original"}),e.jsx(r,{gap:"100",children:l.processed&&l.processedUrl&&A&&e.jsx(I,{size:"slim",variant:"plain",icon:e.jsx(Ns,{size:14}),onClick:()=>A(l.id),children:"Revert"})})]}),l.error&&e.jsx(n,{variant:"bodySm",tone:"critical",as:"p",children:l.error})]})})},l.id))})]}),!S&&f>0&&e.jsx(ne,{tone:"info",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Bulk editing mode:"})," Controls will apply to ALL ",f," photos. To edit specific photos, select them in the gallery above."]})}),S&&e.jsx(ne,{tone:"info",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Selected photos mode:"})," Controls will apply to the ",h.length,' selected photos. Use "Apply to All" to process every photo instead.']})})]})})]})})},Vs=s=>new Date(s*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),Ne=(s,h=150)=>{const p=s.replace(/<[^>]*>/g,"").replace(/&[^;]+;/g," ");return p.length>h?p.substring(0,h)+"...":p},Gs=({productId:s})=>{const h=Ke(),{addNotification:p}=Re(),[a,j]=i.useState(!1),{data:D,isLoading:P}=oe({queryKey:["draft-by-product",s],queryFn:()=>$.get(`/drafts/product/${s}`),enabled:!!s,refetchInterval:3e4}),A=te({mutationFn:({draftId:g,photos:M,description:R})=>$.post(`/api/drafts/${g}/approve`,{photos:M,description:R}),onSuccess:()=>{h.invalidateQueries({queryKey:["draft-by-product",s]}),h.invalidateQueries({queryKey:["product-info",s]}),h.invalidateQueries({queryKey:["products-overview"]}),p({type:"success",title:"Draft approved",message:"Changes have been applied to the live product",autoClose:4e3})},onError:g=>{p({type:"error",title:"Approval failed",message:g instanceof Error?g.message:"Unknown error"})}}),y=te({mutationFn:g=>$.post(`/api/drafts/${g}/reject`),onSuccess:()=>{h.invalidateQueries({queryKey:["draft-by-product",s]}),p({type:"success",title:"Draft dismissed",autoClose:3e3})},onError:g=>{p({type:"error",title:"Failed to dismiss draft",message:g instanceof Error?g.message:"Unknown error"})}}),v=(g,M)=>{D?.draft&&A.mutate({draftId:D.draft.id,photos:g,description:M})},E=()=>{D?.draft&&y.mutate(D.draft.id)};if(P||!D?.draft||D.draft.status!=="pending")return null;const{draft:C,live:S}=D,f=!!C.draft_description,z=C.draftImages.length>0;return e.jsx(T,{children:e.jsx(ne,{title:"AI has generated a new description for this product",action:{content:a?"Hide preview":"Show preview",onAction:()=>j(!a)},secondaryAction:{content:"Dismiss",onAction:E},children:e.jsxs(x,{gap:"300",children:[e.jsxs(r,{gap:"200",align:"space-between",children:[e.jsxs(n,{as:"p",variant:"bodyMd",children:["Ready for review ‚Ä¢ Created ",Vs(C.created_at)]}),e.jsx(k,{tone:"attention",children:"Pending Approval"})]}),e.jsxs(We,{children:[e.jsx(I,{variant:"primary",size:"medium",onClick:()=>v(z,f),loading:A.isPending,disabled:!f&&!z,children:"Approve All"}),f&&e.jsx(I,{onClick:()=>v(!1,!0),loading:A.isPending,size:"medium",children:"Approve Description Only"}),z&&e.jsx(I,{onClick:()=>v(!0,!1),loading:A.isPending,size:"medium",children:"Approve Photos Only"})]}),a&&e.jsx(O,{padding:"400",background:"bg-surface-secondary",children:e.jsxs(x,{gap:"300",children:[f&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"headingSm",as:"h4",children:"Description Changes"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsx(T,{children:e.jsxs(x,{gap:"200",children:[e.jsx(n,{variant:"bodySm",as:"h5",tone:"subdued",children:"Current"}),e.jsx("div",{style:{fontSize:"13px",lineHeight:1.4,maxHeight:"200px",overflow:"auto"},children:S.description?e.jsx("div",{dangerouslySetInnerHTML:{__html:Ne(S.description,300)}}):e.jsx(n,{as:"p",tone:"subdued",children:e.jsx("em",{children:"No description"})})})]})}),e.jsx(T,{children:e.jsxs(x,{gap:"200",children:[e.jsx(n,{variant:"bodySm",as:"h5",tone:"subdued",children:"Proposed"}),e.jsx("div",{style:{fontSize:"13px",lineHeight:1.4,maxHeight:"200px",overflow:"auto"},children:C.draft_description?e.jsx("div",{style:{whiteSpace:"pre-wrap"},children:Ne(C.draft_description,300)}):e.jsx(n,{as:"p",tone:"subdued",children:e.jsx("em",{children:"No changes"})})})]})})]})]}),z&&e.jsxs(e.Fragment,{children:[f&&e.jsx(X,{}),e.jsx(n,{variant:"headingSm",as:"h4",children:"Image Changes"}),e.jsxs(r,{gap:"200",children:[e.jsxs(n,{as:"p",variant:"bodyMd",children:[e.jsx("strong",{children:C.draftImages.length})," processed images ready"]}),S.images.length>0&&e.jsxs(n,{as:"p",variant:"bodyMd",tone:"subdued",children:["(replacing ",S.images.length," current)"]})]})]})]})})]})})})};function ue(s){return s.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/`(.+?)`/g,"<code>$1</code>")}function Ae(s){const p=s.replace(/^\*\*Title line:\*\*\s*/gm,"").replace(/^Title line:\s*/gm,"").replace(/^\*\*Intro:\*\*\s*/gm,"").replace(/^Intro:\s*/gm,"").split(`
`),a=[];let j=!1;for(const D of p){const P=D.trim();if(!P){j&&(a.push("</ul>"),j=!1);continue}if(P.startsWith("### ")){j&&(a.push("</ul>"),j=!1),a.push(`<h3>${ue(P.slice(4))}</h3>`);continue}if(P.startsWith("## ")){j&&(a.push("</ul>"),j=!1),a.push(`<h2>${ue(P.slice(3))}</h2>`);continue}if(P.startsWith("# ")){j&&(a.push("</ul>"),j=!1),a.push(`<h1>${ue(P.slice(2))}</h1>`);continue}const A=P.match(/^[-*‚úî‚úÖ‚òë‚óè‚Ä¢‚ñ∫‚ñ∏]\s*(.+)/);if(A){j||(a.push("<ul>"),j=!0),a.push(`<li>${ue(A[1])}</li>`);continue}j&&(a.push("</ul>"),j=!1),a.push(`<p>${ue(P)}</p>`)}return j&&a.push("</ul>"),a.join(`
`)}const Js="https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png",ge=s=>{if(s==null||s==="")return"-";const h=typeof s=="string"?Number(s):s;return Number.isNaN(h)?"-":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(h)},Oe=s=>{const h=(s||"").toLowerCase();return h==="active"?e.jsx(k,{tone:"success",children:"Active"}):h==="draft"?e.jsx(k,{children:"Draft"}):h==="archived"?e.jsx(k,{tone:"warning",children:"Archived"}):e.jsx(k,{children:s||"unknown"})},Xs=s=>s==="listed"?e.jsx(k,{tone:"success",children:"Listed"}):s==="draft"?e.jsx(k,{tone:"info",children:"Draft"}):e.jsx(n,{as:"span",tone:"subdued",children:"-"}),qe=({done:s,label:h})=>e.jsxs(r,{gap:"100",blockAlign:"center",wrap:!1,children:[e.jsx("span",{style:{display:"inline-block",width:8,height:8,borderRadius:"50%",backgroundColor:s?"#22c55e":"#d1d5db"}}),h&&e.jsx(n,{as:"span",tone:s?void 0:"subdued",variant:"bodySm",children:h})]}),at=()=>{const{id:s}=hs(),h=Ue(),p=Ke(),{addNotification:a}=Re(),[j,D]=i.useState("side-by-side"),[P,A]=i.useState(null),[y,v]=i.useState(null),[E,C]=i.useState(!1),[S,f]=i.useState(!1),[z,g]=i.useState([]),[M,R]=i.useState(!1),[K,_]=i.useState(new Set),[W,l]=i.useState(!1),[U,ie]=i.useState(null),[H,Y]=i.useState(null),[N,Z]=i.useState(null),V=ms(s);ke.useEffect(()=>{V.data&&Z(V.data)},[V.data]);const{data:d,isLoading:F}=fs(s),L=ys(s),{data:G}=bs(s),o=js(),[u,ae]=i.useState(""),[ee,pe]=i.useState(!1);ke.useEffect(()=>{G?.notes!==void 0&&!ee&&(ae(G.notes),pe(!0))},[G,ee]),ke.useEffect(()=>{pe(!1)},[s]);const{data:Ve,isLoading:Ge}=oe({queryKey:["product-info",s],queryFn:()=>$.get(`/test/product-info/${s}`),enabled:!!s}),{data:Je}=oe({queryKey:["product-pipeline-status",s],queryFn:()=>$.get(`/products/${s}/pipeline-status`),enabled:!!s,retry:1}),{data:Xe}=oe({queryKey:["pipeline-jobs",s],queryFn:()=>$.get(`/pipeline/jobs?productId=${s}&limit=1`),enabled:!!s,refetchInterval:1e4}),{data:Ye,isLoading:$e}=oe({queryKey:["active-photos",s],queryFn:async()=>((await $.get(`/test/product-info/${s}`))?.product?.images||[]).map(m=>({id:m.id,position:m.position,src:m.src,alt:m.alt})),enabled:!!s,refetchInterval:1e4}),Q=Ye??[],{data:Ze,isLoading:Ys}=oe({queryKey:["product-images",s],queryFn:()=>$.get(`/products/${s}/images`),enabled:!!s,refetchInterval:15e3}),es=Ze?.images??[],ss=Q.map(t=>{const c=es.find(m=>m.originalUrl===t.src);return{id:t.id,originalUrl:t.src,alt:t.alt,processing:K.has(t.id),processed:!!c?.processedUrl,processedUrl:c?.processedUrl}}),{data:De}=vs({limit:50,offset:0,search:s}),q=i.useMemo(()=>{const t=(De?.data??[]).map(c=>({shopifyProductId:String(c.shopifyProductId??c.shopify_product_id??c.shopifyProductID??c.id??""),ebayListingId:c.ebayListingId??c.ebay_listing_id??c.ebayItemId??null,status:c.status??"inactive"}));return t.find(c=>c.shopifyProductId===s)??t[0]??null},[De,s]),b=Ve?.product,se=b?.variant??b?.variants?.[0],ts=b?.images??[],le=Xe?.jobs?.[0],be=le?.steps??[],je=Je?.status?.ai_description??null,Me=te({mutationFn:()=>$.post(`/auto-list/${s}`),onSuccess:async t=>{if(t?.success||t?.ok){ie(t),a({type:"success",title:"Pipeline completed!",message:"Review the results in the Review Queue.",autoClose:4e3});try{const c=await $.get(`/drafts/product/${s}`);c?.draft?.id&&h(`/review/${c.draft.id}`)}catch{}}else a({type:"error",title:"Pipeline failed",message:t?.error||"AI processing did not return complete results. Try again."});p.invalidateQueries({queryKey:["product-pipeline-status",s]}),p.invalidateQueries({queryKey:["pipeline-jobs",s]})},onError:t=>{a({type:"error",title:"Pipeline failed to start",message:t instanceof Error?t.message:"Unknown error"})}}),Fe=te({mutationFn:()=>$.post(`/auto-list/${s}`),onSuccess:()=>{a({type:"success",title:"AI description generated",autoClose:4e3}),p.invalidateQueries({queryKey:["product-pipeline-status",s]})},onError:t=>{a({type:"error",title:"AI generation failed",message:t instanceof Error?t.message:"Unknown error"})}}),ve=te({mutationFn:({imageUrl:t,params:c})=>$.post(`/products/${s}/images/reprocess`,{imageUrl:t,background:c.background,padding:c.padding,shadow:c.shadow}),onSuccess:t=>{v(t?.processedUrl??null),p.invalidateQueries({queryKey:["product-images",s]}),a({type:"success",title:"Image reprocessed successfully",autoClose:4e3})},onError:t=>{a({type:"error",title:"Reprocessing failed",message:t instanceof Error?t.message:"Unknown error"})}}),de=te({mutationFn:t=>$.post(`/products/${s}/images/reprocess-all`,{background:t.background,padding:t.padding,shadow:t.shadow}),onSuccess:t=>{p.invalidateQueries({queryKey:["product-images",s]}),a({type:"success",title:"All images reprocessed",message:`${t?.succeeded??0} succeeded, ${t?.failed??0} failed`,autoClose:4e3})},onError:t=>{a({type:"error",title:"Bulk reprocessing failed",message:t instanceof Error?t.message:"Unknown error"})}}),ns=i.useCallback((t,c)=>{v(null),ve.mutate({imageUrl:t,params:c})},[ve]),is=i.useCallback(t=>{de.mutate(t)},[de]);i.useCallback(t=>{A(c=>c===t.originalUrl?null:t.originalUrl),v(null)},[]);const as=b?.status?Oe(b.status):null;i.useCallback(t=>{A(t),C(!0)},[]);const ze=te({mutationFn:t=>$.delete(`/products/${s}/images/${t}`),onSuccess:()=>{p.invalidateQueries({queryKey:["active-photos",s]}),p.invalidateQueries({queryKey:["product-images",s]}),a({type:"success",title:"Image deleted",autoClose:3e3})},onError:t=>{a({type:"error",title:"Delete failed",message:t instanceof Error?t.message:"Unknown error"})}}),Ee=te({mutationFn:t=>$.delete(`/products/${s}/images`,{imageIds:t}),onSuccess:t=>{p.invalidateQueries({queryKey:["active-photos",s]}),p.invalidateQueries({queryKey:["product-images",s]}),g([]);const c=t?.succeeded||0,m=t?.failed||0;a({type:"success",title:`Deleted ${c} image${c!==1?"s":""}${m>0?`, ${m} failed`:""}`,autoClose:4e3})},onError:t=>{a({type:"error",title:"Bulk delete failed",message:t instanceof Error?t.message:"Unknown error"})}});te({mutationFn:async t=>{const c=[];t.description&&U?.description&&c.push($.post("/test/update-product",{productId:s,body_html:Ae(U.description)})),t.photos&&U?.images&&console.log("Applying processed photos:",U.images),t.ebayListing&&c.push($.post("/ebay/create-draft",{productId:s,description:U?.description,categoryId:U?.categoryId,images:U?.images})),await Promise.all(c)},onSuccess:()=>{a({type:"success",title:"Changes applied successfully!",autoClose:4e3}),p.invalidateQueries({queryKey:["product-info",s]}),p.invalidateQueries({queryKey:["draft",s]})},onError:t=>{a({type:"error",title:"Failed to apply changes",message:t instanceof Error?t.message:"Unknown error"})}});const{data:Se}=oe({queryKey:["draft",s],queryFn:()=>$.get(`/drafts/product/${s}`)}),os=i.useCallback(async(t,c)=>{const m=Q.find(w=>w.id===t);if(m){_(w=>new Set(w).add(t));try{await $.post(`/products/${s}/images/reprocess`,{imageUrl:m.src,...c}),p.invalidateQueries({queryKey:["product-images",s]}),a({type:"success",title:"Photo processed",autoClose:3e3})}catch(w){a({type:"error",title:"Processing failed",message:w instanceof Error?w.message:"Unknown error"})}finally{_(w=>{const B=new Set(w);return B.delete(t),B})}}},[Q,s,p,a]),rs=i.useCallback(async(t,c)=>{_(B=>new Set([...B,...t]));let m=0,w=0;for(const B of t){const J=Q.find(ce=>ce.id===B);if(J)try{await $.post(`/products/${s}/images/reprocess`,{imageUrl:J.src,...c}),m++}catch{w++}}_(B=>{const J=new Set(B);return t.forEach(ce=>J.delete(ce)),J}),p.invalidateQueries({queryKey:["product-images",s]}),m>0&&w===0?a({type:"success",title:`Processed ${m} photo${m!==1?"s":""}`,autoClose:3e3}):m>0?a({type:"warning",title:`Processed ${m}, ${w} failed`,autoClose:4e3}):a({type:"error",title:`Failed to process ${w} photo${w!==1?"s":""}`,autoClose:4e3})},[Q,s,p,a]),ls=i.useCallback(async t=>{try{const c=await de.mutateAsync(t);a({type:"success",title:"All photos processed",message:`${c?.succeeded??0} succeeded, ${c?.failed??0} failed`,autoClose:4e3})}catch{}},[de,a]),ds=i.useCallback(t=>{g(t),R(!0)},[]),cs=i.useCallback(t=>{ze.mutate(t)},[ze]),ps=i.useCallback(t=>{Ee.mutate(t)},[Ee]),us=i.useCallback(t=>({fetch_product:"Fetch Product",generate_description:"Generate Description",process_images:"Process Images",create_ebay_listing:"Save to Review"})[t]||t.replace(/_/g," ").replace(/\b\w/g,m=>m.toUpperCase()),[]),he=d?.match?.condition?d.match.condition.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase()):null,we=q?.ebayListingId?q.ebayListingId.startsWith("draft-")?"eBay Draft":"Listed on eBay":null;return e.jsxs(e.Fragment,{children:[e.jsxs(He,{title:b?.title??"Loading product‚Ä¶",subtitle:b?`${se?.sku||"No SKU"} ¬∑ ${ge(se?.price)}`:void 0,titleMetadata:b?e.jsxs(r,{gap:"200",children:[as,he&&e.jsx(k,{tone:"info",children:he}),we&&e.jsx(k,{tone:we==="Listed on eBay"?"success":"attention",children:we})]}):void 0,backAction:{content:"Products",onAction:()=>h("/listings")},primaryAction:{content:"üöÄ Run Pipeline",onAction:()=>Me.mutate(),loading:Me.isPending},secondaryActions:b?[{content:"Shopify Admin",icon:Ce,url:`https://admin.shopify.com/store/usedcameragear/products/${s}`,external:!0},...b?.handle?[{content:"Live Page",icon:Ce,url:`https://usedcameragear.myshopify.com/products/${b.handle}`,external:!0}]:[],...q?.ebayListingId&&!q.ebayListingId.startsWith("draft-")?[{content:"View on eBay",icon:Ce,url:`https://www.ebay.com/itm/${q.ebayListingId}`,external:!0}]:[]]:void 0,children:[Ge&&e.jsx("div",{style:{padding:"4rem",textAlign:"center"},children:e.jsx(me,{accessibilityLabel:"Loading product",size:"large"})}),b&&e.jsxs("div",{children:[Se&&Se?.draft?.id&&e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(ne,{title:"Draft ready for review",tone:"info",action:{content:"Review Now",onAction:()=>h(`/review/${Se.draft.id}`)},children:e.jsx("p",{children:"Pipeline has completed for this product. Review and apply the changes."})})}),e.jsx(Gs,{productId:s}),N&&e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(ne,{title:N.success?"Drive Pipeline Complete":"Drive Pipeline Issue",tone:N.success?"success":"warning",onDismiss:()=>Z(null),children:N.success?e.jsxs(x,{gap:"100",children:[e.jsxs(n,{as:"p",variant:"bodySm",children:["Found ",N.photos?.count," photos in ",N.photos?.presetName,"/",N.photos?.folderName]}),N.description?.generated&&e.jsx(n,{as:"p",variant:"bodySm",children:"‚úÖ AI description generated"}),N.condition?.tagApplied&&e.jsxs(n,{as:"p",variant:"bodySm",children:["‚úÖ ",N.condition.tag]})]}):e.jsx(n,{as:"p",variant:"bodySm",children:N.error})})}),e.jsxs(Pe,{children:[e.jsx(Pe.Section,{children:e.jsxs(x,{gap:"400",children:[e.jsx(T,{children:e.jsxs(x,{gap:"400",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"300",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Photos"}),Q.length>0&&e.jsx(k,{children:`${Q.length} photo${Q.length!==1?"s":""}`})]}),Q.length>0&&e.jsx(I,{size:"slim",onClick:()=>R(t=>!t),children:M?"Close Editor":"Edit Photos"})]}),Q.length===0&&!$e?e.jsx(O,{padding:"800",borderWidth:"025",borderStyle:"dashed",borderColor:"border",borderRadius:"300",background:"bg-surface-secondary",children:e.jsxs(x,{gap:"300",align:"center",children:[e.jsx("div",{style:{fontSize:"36px",opacity:.4},children:"üì∑"}),e.jsx(n,{variant:"headingSm",as:"h3",tone:"subdued",children:"No photos yet"}),e.jsx(n,{variant:"bodySm",as:"p",tone:"subdued",children:"Run the pipeline to search Google Drive for photos, or upload them in Shopify Admin."}),e.jsx("div",{style:{marginTop:"8px"},children:e.jsx(I,{size:"slim",onClick:()=>V.mutate(),loading:V.isPending,children:"üì∏ Search Drive for Photos"})})]})}):e.jsx(Hs,{photos:Q,loading:$e,onDeleteSingle:cs,onDeleteBulk:ps,onEditPhotos:ds,onSelectionChange:g,onEditPhoto:(t,c)=>Y({photo:t,index:c})})]})}),e.jsx(Os,{photos:ss,selectedPhotoIds:z,isOpen:M,onToggle:()=>R(t=>!t),onProcessSingle:os,onProcessSelected:rs,onProcessAll:ls,processing:de.isPending||K.size>0}),je&&e.jsx(T,{children:e.jsx("div",{style:{padding:"16px",background:"linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)",borderRadius:"12px",border:"2px solid #0ea5e9",margin:"-16px"},children:e.jsxs(x,{gap:"300",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"200",blockAlign:"center",children:[e.jsx(n,{variant:"headingSm",as:"h3",children:"ü§ñ AI Generated Description"}),e.jsx(k,{tone:"info",children:"Ready to Apply"})]}),e.jsxs(r,{gap:"200",children:[e.jsx(I,{variant:"primary",size:"slim",onClick:async()=>{try{const t=Ae(je);await $.post("/api/test/update-product",{productId:s,body_html:t}),a({type:"success",title:"Description updated",message:"AI description has been applied to your product",autoClose:4e3}),p.invalidateQueries({queryKey:["product-info",s]})}catch(t){a({type:"error",title:"Update failed",message:t instanceof Error?t.message:"Failed to update product description"})}},children:"Apply Description"}),e.jsx(I,{size:"slim",onClick:()=>{p.setQueryData(["product-pipeline-status",s],t=>({...t,status:{...t?.status,ai_description:null}}))},children:"Dismiss"})]})]}),e.jsx("div",{style:{maxHeight:"300px",overflow:"auto",padding:"16px",background:"#ffffff",borderRadius:"8px",border:"1px solid #bae6fd",fontSize:"14px",lineHeight:"1.7",color:"#1a1a1a"},dangerouslySetInnerHTML:{__html:Ae(je)}})]})})}),e.jsx(T,{children:e.jsxs(x,{gap:"400",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Description"}),e.jsx(I,{icon:Cs,onClick:()=>Fe.mutate(),loading:Fe.isPending,size:"slim",children:"Regenerate with AI"})]}),b.body_html?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{maxHeight:"400px",overflow:"auto",padding:"20px",background:"#f9fafb",borderRadius:"8px",border:"1px solid #e3e5e7",fontSize:"14px",lineHeight:"1.7",color:"#1a1a1a"},dangerouslySetInnerHTML:{__html:b.body_html}}),e.jsxs("details",{children:[e.jsx("summary",{style:{padding:"8px 12px",background:"#f8f9fa",borderRadius:"6px",border:"1px solid #e5e7eb",cursor:"pointer",fontFamily:"SF Mono, Monaco, monospace",fontSize:"13px",userSelect:"none",color:"#6b7280"},children:"View HTML source"}),e.jsx("div",{style:{marginTop:"8px",maxHeight:"200px",overflow:"auto",padding:"16px",background:"#1e1e1e",color:"#d4d4d4",borderRadius:"8px",fontFamily:"SF Mono, Monaco, Consolas, monospace",fontSize:"12px",lineHeight:"1.5"},children:e.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap"},children:b.body_html})})]})]}):e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px"},children:[e.jsx("div",{style:{fontSize:"32px",opacity:.3,marginBottom:"12px"},children:"üìù"}),e.jsx(n,{variant:"headingSm",as:"h3",tone:"subdued",children:"No description yet"}),e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:'Run the pipeline or click "Regenerate with AI" to create a description.'})]})]})}),e.jsx(T,{children:e.jsxs(x,{gap:"300",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"200",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Notes"}),u.trim()&&e.jsx(k,{tone:"attention",children:"Has Notes"})]}),e.jsx(I,{variant:"primary",size:"slim",onClick:()=>{s&&o.mutate({productId:s,notes:u})},loading:o.isPending,disabled:!s||u===(G?.notes??""),children:"Save"})]}),e.jsx(Le,{label:"",labelHidden:!0,value:u,onChange:ae,multiline:3,placeholder:"Condition notes, blemishes, missing accessories‚Ä¶ Included in AI descriptions.",autoComplete:"off",onBlur:()=>{s&&u!==(G?.notes??"")&&o.mutate({productId:s,notes:u})}})]})}),e.jsx(Fs,{productId:s,onApplied:()=>{p.invalidateQueries({queryKey:["product-images",s]})}})]})}),e.jsx(Pe.Section,{variant:"oneThird",children:e.jsxs(x,{gap:"400",children:[e.jsx(T,{children:e.jsxs(x,{gap:"400",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Pipeline"}),le?.status&&e.jsx(k,{tone:le.status==="completed"?"success":le.status==="failed"?"critical":le.status==="running"?"attention":"info",children:le.status})]}),be.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"16px 0"},children:[e.jsx("div",{style:{fontSize:"28px",opacity:.3,marginBottom:"8px"},children:"‚ö°"}),e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:"No pipeline runs yet"})]}):e.jsx(x,{gap:"0",children:be.map((t,c)=>{const m=c===be.length-1,w=t.status==="done",B=t.status==="error",J=t.status==="running";return e.jsx("div",{style:{padding:"2px 4px"},children:e.jsxs(r,{gap:"300",blockAlign:"start",children:[e.jsxs("div",{style:{position:"relative",marginTop:"2px"},children:[e.jsxs("div",{style:{width:"16px",height:"16px",borderRadius:"50%",border:`2px solid ${w?"#22c55e":B?"#ef4444":J?"#f59e0b":"#d1d5db"}`,backgroundColor:w?"#22c55e":"#ffffff",position:"relative",zIndex:1},children:[w&&e.jsx("svg",{viewBox:"0 0 12 12",style:{position:"absolute",inset:"1px",fill:"#fff"},children:e.jsx("path",{d:"M10 3L4.5 8.5 2 6",stroke:"#fff",strokeWidth:"2",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})}),J&&e.jsx("div",{style:{position:"absolute",inset:"2px",borderRadius:"50%",backgroundColor:"#f59e0b",opacity:.7}})]}),!m&&e.jsx("div",{style:{position:"absolute",top:"18px",left:"50%",transform:"translateX(-50%)",width:"2px",height:"20px",backgroundColor:w?"#22c55e":"#e5e7eb"}})]}),e.jsxs("div",{style:{flex:1,paddingBottom:m?"0":"12px"},children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{as:"span",variant:"bodySm",fontWeight:w?"medium":"regular",tone:B?"critical":void 0,children:us(t.name)}),e.jsx(n,{as:"span",variant:"bodySm",tone:w?"success":B?"critical":"subdued",children:w?"‚úì":B?"‚úó":J?"‚ãØ":"‚óã"})]}),t.error&&e.jsx(n,{variant:"bodySm",tone:"critical",as:"p",children:t.error})]})]})},t.name)})}),e.jsx(X,{}),e.jsx(I,{fullWidth:!0,onClick:()=>V.mutate(),loading:V.isPending,size:"slim",children:"üì∏ Search Drive for Photos"})]})}),e.jsx(T,{children:e.jsxs(x,{gap:"300",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Details"}),e.jsx(X,{}),e.jsxs(x,{gap:"200",children:[e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Price"}),e.jsx(n,{variant:"bodySm",fontWeight:"medium",as:"span",children:ge(se?.price??null)})]}),se?.compare_at_price&&e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Compare-at"}),e.jsx(n,{variant:"bodySm",as:"span",children:ge(se.compare_at_price)})]}),e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"SKU"}),e.jsx("span",{style:{fontFamily:"SF Mono, monospace",fontSize:"13px"},children:se?.sku??"‚Äî"})]}),se?.barcode&&e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Barcode"}),e.jsx("span",{style:{fontFamily:"SF Mono, monospace",fontSize:"13px"},children:se.barcode})]}),e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Inventory"}),e.jsx(n,{variant:"bodySm",fontWeight:"medium",as:"span",children:se?.inventory_quantity??"‚Äî"})]}),b.vendor&&e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Vendor"}),e.jsx(n,{variant:"bodySm",as:"span",children:b.vendor})]}),b.product_type&&e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Type"}),e.jsx(n,{variant:"bodySm",as:"span",children:b.product_type})]})]}),b.tags&&e.jsxs(e.Fragment,{children:[e.jsx(X,{}),e.jsx(r,{gap:"100",wrap:!0,children:(typeof b.tags=="string"?b.tags.split(","):b.tags).filter(t=>t.trim()).map(t=>e.jsx(k,{children:t.trim()},t.trim()))})]})]})}),(d?.match||F)&&e.jsx(T,{children:e.jsxs(x,{gap:"300",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"Condition"}),he&&e.jsx(k,{tone:d.match.condition==="like_new_minus"||d.match.condition==="excellent_plus"||d.match.condition==="excellent"?"success":d.match.condition==="poor"||d.match.condition==="ugly"?"warning":"info",children:he})]}),F?e.jsx("div",{style:{padding:"8px",textAlign:"center"},children:e.jsx(me,{size:"small"})}):d?.match?e.jsxs(x,{gap:"200",children:[d.match.conditionNotes&&e.jsx(n,{variant:"bodySm",as:"p",children:d.match.conditionNotes}),d.match.graderNotes&&e.jsx(n,{variant:"bodySm",tone:"subdued",as:"p",children:d.match.graderNotes}),d.match.serialNumber&&e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Serial #"}),e.jsx("span",{style:{fontFamily:"SF Mono, monospace",fontSize:"13px"},children:d.match.serialNumber})]}),e.jsx(X,{}),e.jsxs(r,{align:"space-between",blockAlign:"center",children:[(()=>{const c=(typeof b.tags=="string"?b.tags.split(",").map(m=>m.trim()):b.tags??[]).find(m=>m.startsWith("condition-"));return c?e.jsx(k,{tone:"success",children:c}):e.jsx(k,{tone:"attention",children:"Not tagged"})})(),d.match.condition&&e.jsx(I,{size:"slim",onClick:()=>L.mutate(),loading:L.isPending,children:(typeof b.tags=="string"?b.tags.split(",").map(m=>m.trim()):b.tags??[]).find(m=>m.startsWith("condition-"))?"Update Tag":"Tag Product"})]}),L.isSuccess&&L.data&&e.jsx(ne,{tone:"success",onDismiss:()=>L.reset(),children:L.data.newTag?`Tagged: ${L.data.newTag}`:"Tag applied successfully"}),L.isError&&e.jsx(ne,{tone:"critical",onDismiss:()=>L.reset(),children:"Failed to apply tag"})]}):null]})}),q?.ebayListingId&&e.jsx(T,{children:e.jsxs(x,{gap:"300",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{variant:"headingMd",as:"h2",children:"eBay"}),q.ebayListingId.startsWith("draft-")?e.jsx(k,{tone:"attention",children:"Draft"}):e.jsx(k,{tone:q.status==="active"||q.status==="synced"?"success":"info",children:q.status==="synced"?"Live":q.status})]}),e.jsxs(r,{align:"space-between",children:[e.jsx(n,{variant:"bodySm",tone:"subdued",as:"span",children:"Item ID"}),e.jsx("span",{style:{fontFamily:"SF Mono, monospace",fontSize:"13px"},children:q.ebayListingId})]}),e.jsxs(x,{gap:"200",children:[!q.ebayListingId.startsWith("draft-")&&e.jsx(I,{fullWidth:!0,size:"slim",url:`https://www.ebay.com/itm/${q.ebayListingId}`,external:!0,children:"View on eBay"}),e.jsx(I,{fullWidth:!0,variant:"plain",size:"slim",onClick:()=>h(`/ebay/listings/${q.shopifyProductId}`),children:"Listing Details"})]})]})})]})})]})]}),E&&e.jsx("div",{style:{marginTop:"1rem"},children:e.jsx(Qe,{selectedImageUrl:P,onReprocess:ns,onReprocessAll:is,reprocessing:ve.isPending,reprocessingAll:de.isPending,previewUrl:y,imageCount:ts.length})}),e.jsx("div",{style:{height:"2rem"}})]}),H&&e.jsx(zs,{open:!0,imageUrl:H.photo.src,imageIndex:H.index,productId:s,allDraftImages:Q.map(t=>t.src),onSave:()=>{p.invalidateQueries({queryKey:["active-photos",s]}),p.invalidateQueries({queryKey:["product-info",s]}),Y(null),a({type:"success",title:"Photo updated",message:"Edited photo saved to Shopify",autoClose:4e3})},onClose:()=>Y(null),onCustomSave:async t=>{const c=new FileReader,m=await new Promise((B,J)=>{c.onload=()=>{const ce=c.result;B(ce.split(",")[1])},c.onerror=J,c.readAsDataURL(t)}),w=await fetch(`/api/products/${s}/images/${H.photo.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({attachment:m,filename:`edited-${H.photo.id}-${Date.now()}.png`,position:H.photo.position})});if(!w.ok){const B=await w.json().catch(()=>({error:"Replace failed"}));throw new Error(B.error||`Replace failed (${w.status})`)}p.invalidateQueries({queryKey:["active-photos",s]}),p.invalidateQueries({queryKey:["product-info",s]}),Y(null),a({type:"success",title:"Photo updated",message:"Edited photo saved to Shopify",autoClose:4e3})}})]})},Ie=[{id:"all",content:"All"},{id:"draft",content:"Draft"},{id:"active",content:"Active"},{id:"needs_description",content:"Needs Description"},{id:"needs_images",content:"Needs Images"},{id:"listed",content:"On eBay"}],ot=()=>{const s=Ue(),{addNotification:h}=Re(),[p,a]=i.useState(""),[j,D]=i.useState(0),[P,A]=i.useState(1),y=50,{data:v,isLoading:E,error:C}=oe({queryKey:["products-overview"],queryFn:()=>$.get("/products/overview"),refetchInterval:3e4}),S=i.useMemo(()=>v?.products??[],[v?.products]),f=i.useMemo(()=>{const o=S.filter(u=>(u.shopifyStatus??"").toLowerCase()!=="archived");return{all:o.length,draft:o.filter(u=>(u.shopifyStatus??"").toLowerCase()==="draft").length,active:o.filter(u=>(u.shopifyStatus??"").toLowerCase()==="active").length,needs_description:o.filter(u=>!u.hasAiDescription).length,needs_images:o.filter(u=>!u.hasProcessedImages).length,listed:o.filter(u=>u.ebayStatus==="listed"||u.ebayStatus==="draft").length}},[S]),z=i.useMemo(()=>Ie.map(o=>({...o,content:`${o.content} (${f[o.id]})`})),[f]),g=i.useMemo(()=>Ie[j]?.id??"all",[j]),M=i.useMemo(()=>{const o=p.trim().toLowerCase();return S.filter(u=>{if((u.shopifyStatus??"").toLowerCase()==="archived"||!(!o||u.title.toLowerCase().includes(o)||u.sku.toLowerCase().includes(o)))return!1;const ee=(u.shopifyStatus??"").toLowerCase();switch(g){case"draft":return ee==="draft";case"active":return ee==="active";case"needs_description":return!u.hasAiDescription;case"needs_images":return!u.hasProcessedImages;case"listed":return u.ebayStatus==="listed"||u.ebayStatus==="draft";default:return!0}})},[S,p,g]),R=i.useMemo(()=>{const o={draft:0,active:1};return[...M].sort((u,ae)=>{const ee=o[(u.shopifyStatus??"").toLowerCase()]??2,pe=o[(ae.shopifyStatus??"").toLowerCase()]??2;return ee!==pe?ee-pe:u.title.localeCompare(ae.title)})},[M]),K=Math.max(1,Math.ceil(R.length/y)),_=Math.min(P,K),W=R.slice((_-1)*y,_*y),{selectedResources:l,allResourcesSelected:U,handleSelectionChange:ie}=Ps(W,{resourceIDResolver:o=>o.shopifyProductId}),[H,Y]=i.useState(!1),[N,Z]=i.useState(null),V=i.useCallback(async()=>{const o=l;if(o.length!==0){Y(!0),Z({done:0,total:o.length});for(let u=0;u<o.length;u++){const ae=W.find(ee=>ee.shopifyProductId===o[u]);Z({done:u,total:o.length,current:ae?.title||o[u]});try{await fetch(`/api/pipeline/trigger/${o[u]}`,{method:"POST"})}catch{}}Z({done:o.length,total:o.length}),Y(!1),setTimeout(()=>Z(null),3e3),ie("page",!1)}},[l,W,ie]),d=[{content:H?`Running pipeline (${N?.done??0}/${N?.total??0})...`:`Run Pipeline (${l.length})`,onAction:V,disabled:H}],F=i.useCallback(o=>{o>=0&&o<Ie.length&&(D(o),A(1))},[]),L=W.map((o,u)=>e.jsxs(re.Row,{id:o.shopifyProductId,position:u,selected:l.includes(o.shopifyProductId),onClick:()=>s(`/listings/${o.shopifyProductId}`),children:[e.jsx(re.Cell,{children:e.jsxs(r,{gap:"300",blockAlign:"center",wrap:!1,children:[e.jsx(xe,{size:"extraSmall",source:o.imageUrl||Js,alt:o.title}),e.jsxs(x,{gap:"050",children:[e.jsxs(r,{gap:"200",blockAlign:"center",wrap:!1,children:[e.jsx(n,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:o.title}),Oe(o.shopifyStatus)]}),o.sku&&e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:o.sku})]})]})}),e.jsx(re.Cell,{children:e.jsx(n,{as:"span",variant:"bodyMd",children:ge(o.price)})}),e.jsx(re.Cell,{children:e.jsx(qe,{done:o.hasAiDescription})}),e.jsx(re.Cell,{children:e.jsx(qe,{done:o.hasProcessedImages})}),e.jsx(re.Cell,{children:Xs(o.ebayStatus)})]},o.shopifyProductId)),G=v?.summary??{total:0,withDescriptions:0,withProcessedImages:0,listedOnEbay:0,draftOnEbay:0};return e.jsx(He,{title:"Products",subtitle:`${G.total.toLocaleString()} products ¬∑ ${G.withDescriptions} descriptions ¬∑ ${G.withProcessedImages} images ¬∑ ${G.listedOnEbay+G.draftOnEbay} on eBay`,fullWidth:!0,children:e.jsxs(x,{gap:"0",children:[e.jsxs(T,{padding:"0",children:[e.jsx(As,{tabs:z,selected:j,onSelect:F}),e.jsx(O,{padding:"300",children:e.jsx(Le,{label:"",placeholder:"Search products‚Ä¶",value:p,onChange:o=>{a(o),A(1)},prefix:e.jsx(Is,{source:Rs}),clearButton:!0,onClearButtonClick:()=>a(""),autoComplete:"off"})}),C&&e.jsx(O,{padding:"300",children:e.jsx(ne,{tone:"critical",title:"Unable to load products",children:e.jsx("p",{children:C instanceof Error?C.message:"Something went wrong."})})}),E?e.jsx(O,{padding:"800",children:e.jsx(r,{align:"center",children:e.jsx(me,{accessibilityLabel:"Loading products",size:"large"})})}):e.jsx(re,{resourceName:{singular:"product",plural:"products"},itemCount:W.length,selectable:!0,selectedItemsCount:U?"All":l.length,onSelectionChange:ie,bulkActions:d,headings:[{title:"Product"},{title:"Price"},{title:"AI Desc"},{title:"Images"},{title:"eBay"}],children:L})]}),e.jsx(O,{padding:"400",children:e.jsxs(r,{align:"center",gap:"400",children:[e.jsx(n,{tone:"subdued",as:"p",children:R.length===0?"No products match your filters":`Showing ${(_-1)*y+1}-${Math.min(_*y,R.length)} of ${R.length}`}),e.jsx(Ls,{hasPrevious:_>1,onPrevious:()=>A(o=>Math.max(1,o-1)),hasNext:_<K,onNext:()=>A(o=>Math.min(K,o+1))})]})})]})})};export{at as ShopifyProductDetail,ot as default};
