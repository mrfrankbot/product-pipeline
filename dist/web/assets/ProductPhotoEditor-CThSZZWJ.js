import{r as a,j as o}from"./vendor-react-DzgxJkbp.js";const Y={rotation:0,scale:1,offsetX:0,offsetY:0},Z=4e3,R=380,J={position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:2147483647,display:"flex",alignItems:"center",justifyContent:"center"},q={position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.5)"},K={position:"relative",background:"#fff",borderRadius:"12px",width:"90vw",maxWidth:"680px",maxHeight:"90vh",overflow:"auto",boxShadow:"0 25px 50px rgba(0,0,0,0.25)",display:"flex",flexDirection:"column"},Q={display:"flex",justifyContent:"space-between",alignItems:"center",padding:"16px 20px",borderBottom:"1px solid #e3e5e7"},ee={padding:"16px 20px",display:"flex",flexDirection:"column",gap:"12px"},te={display:"flex",justifyContent:"flex-end",gap:"8px",padding:"12px 20px",borderTop:"1px solid #e3e5e7"},E={padding:"8px 16px",borderRadius:"6px",border:"1px solid #ccc",background:"#fff",cursor:"pointer",fontSize:"14px"},oe={...E,background:"#2c6ecb",color:"#fff",border:"1px solid #2c6ecb"},O={display:"flex",alignItems:"center",gap:"10px"},ne=({imageUrl:m,draftId:C,imageIndex:P,allDraftImages:A,onSave:M,onClose:y,open:v,onCustomSave:F,productId:U})=>{const S=a.useRef(null),[b,H]=a.useState(null),[f,j]=a.useState({...Y}),[$,T]=a.useState(!1),[W,k]=a.useState(null),[D,I]=a.useState(!0),[X,_]=a.useState(!1),w=a.useRef(null);a.useEffect(()=>{if(!v||!m)return;I(!0),k(null);const e=d=>`/api/images/proxy?url=${encodeURIComponent(d)}`,t=(d,i)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{H(n),I(!1)},n.onerror=()=>{i.length>0?t(i[0],i.slice(1)):(k("Failed to load image."),I(!1))},n.src=d},s=m.match(/(\d{10,})_(\d+)\.png/),c=U||(s?s[1]:null),l=s?s[2]:String(P),r=c?`https://storage.googleapis.com/pictureline-product-photos/processed/${c}_${l}`:null,p=[];r&&(p.push(e(`${r}_cutout.png`)),p.push(e(`${r}_clean.png`)),p.push(e(`${r}.png`))),p.push(m),t(p[0],p.slice(1))},[m,v]),a.useEffect(()=>{j({...Y})},[m]);const L=a.useCallback((e,t,s,c)=>{const{rotation:l,scale:r,offsetX:p,offsetY:d}=c;e.fillStyle="#FFFFFF",e.fillRect(0,0,t,t);const i=s.width/s.height;let n,h;i>1?(n=t*.8,h=n/i):(h=t*.8,n=h*i),e.save();const g=t/2+p,u=t/2+h*r/2+t*.015,x=e.createRadialGradient(g,u,0,g,u,n*r*.5);x.addColorStop(0,"rgba(0,0,0,0.08)"),x.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=x,e.beginPath(),e.ellipse(g,u,n*r*.5,t*.015,0,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.translate(t/2+p,t/2+d),e.rotate(l*Math.PI/180),e.scale(r,r),e.drawImage(s,-n/2,-h/2,n,h),e.restore()},[]),B=a.useCallback((e,t)=>{const s=Z,c=document.createElement("canvas");c.width=s,c.height=s;const l=c.getContext("2d");l.clearRect(0,0,s,s);const r=S.current?.width||R,p=s/r,{rotation:d,scale:i,offsetX:n,offsetY:h}=t,g=e.width/e.height;let u,x;return g>1?(u=s*.8,x=u/g):(x=s*.8,u=x*g),l.save(),l.translate(s/2+n*p,s/2+h*p),l.rotate(d*Math.PI/180),l.scale(i,i),l.drawImage(e,-u/2,-x/2,u,x),l.restore(),c},[]);a.useEffect(()=>{const e=S.current;if(!e||!b)return;const t=e.getContext("2d");t&&L(t,e.width,b,f)},[b,f,L]);const z=a.useCallback(e=>{_(!0),w.current={x:e.clientX,y:e.clientY,offsetX:f.offsetX,offsetY:f.offsetY},e.target.setPointerCapture(e.pointerId)},[f.offsetX,f.offsetY]),G=a.useCallback(e=>{if(!X||!w.current||!S.current)return;const t=S.current,s=t.width/t.clientWidth,c=(e.clientX-w.current.x)*s,l=(e.clientY-w.current.y)*s;j(r=>({...r,offsetX:w.current.offsetX+c,offsetY:w.current.offsetY+l}))},[X]),N=a.useCallback(()=>{_(!1),w.current=null},[]),V=a.useCallback(async()=>{if(b){T(!0),k(null);try{const e=B(b,f),t=await new Promise((d,i)=>{e.toBlob(n=>n?d(n):i(new Error("Canvas toBlob failed")),"image/png")});if(F){const d=new FormData;d.append("image",t,`rotated-${Date.now()}.png`);const i=await fetch("/api/images/reprocess-edited",{method:"POST",body:d});if(!i.ok){const u=await i.json().catch(()=>({error:"Reprocess failed"}));throw new Error(u.error||`PhotoRoom reprocess failed (${i.status})`)}const n=await i.json(),g=await(await fetch(n.dataUrl)).blob();await F(g),y();return}const s=new FormData;s.append("image",t,`rotated-${C}-${P}-${Date.now()}.png`);const c=await fetch("/api/images/reprocess-edited",{method:"POST",body:s});if(!c.ok){const d=await c.json().catch(()=>({error:"Reprocess failed"}));throw new Error(d.error||`PhotoRoom reprocess failed (${c.status})`)}const l=await c.json(),r=[...A];if(r[P]=l.dataUrl,!(await fetch(`/api/drafts/${C}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({images:r})})).ok)throw new Error("Failed to update draft");M(r),y()}catch(e){k(e instanceof Error?e.message:"Save failed")}finally{T(!1)}}},[b,f,C,P,A,M,y,B,F]);return a.useEffect(()=>{if(!v)return;const e=t=>{t.key==="Escape"&&y()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[v,y]),v?o.jsxs("div",{style:J,children:[o.jsx("div",{style:q,onClick:y}),o.jsxs("div",{style:K,children:[o.jsxs("div",{style:Q,children:[o.jsx("h2",{style:{margin:0,fontSize:"16px",fontWeight:600},children:"Edit Product Photo"}),o.jsx("button",{onClick:y,style:{...E,border:"none",fontSize:"18px",padding:"4px 8px"},children:"✕"})]}),o.jsxs("div",{style:ee,children:[W&&o.jsx("div",{style:{background:"#fef2f2",border:"1px solid #fca5a5",borderRadius:"6px",padding:"8px 12px",color:"#991b1b",fontSize:"13px"},children:W}),D?o.jsx("div",{style:{textAlign:"center",padding:"3rem"},children:o.jsx("div",{style:{fontSize:"14px",color:"#6b7280"},children:"Loading image..."})}):o.jsxs(o.Fragment,{children:[o.jsx("div",{style:{display:"flex",justifyContent:"center",background:"#f3f4f6",borderRadius:"8px",padding:"8px"},children:o.jsx("canvas",{ref:S,width:R,height:R,style:{width:`${R}px`,height:`${R}px`,maxWidth:"100%",cursor:X?"grabbing":"grab",borderRadius:"4px",border:"1px solid #e3e5e7"},onPointerDown:z,onPointerMove:G,onPointerUp:N,onPointerLeave:N})}),o.jsx("div",{style:{textAlign:"center",fontSize:"12px",color:"#6b7280"},children:"↕ Drag to reposition · Use sliders to rotate and scale"}),o.jsxs("div",{style:O,children:[o.jsxs("span",{style:{fontSize:"13px",width:"95px",flexShrink:0},children:["Rotation: ",f.rotation,"°"]}),o.jsx("input",{type:"range",min:-180,max:180,step:1,value:f.rotation,onChange:e=>j(t=>({...t,rotation:Number(e.target.value)})),style:{flex:1}})]}),o.jsxs("div",{style:O,children:[o.jsxs("span",{style:{fontSize:"13px",width:"95px",flexShrink:0},children:["Scale: ",Math.round(f.scale*100),"%"]}),o.jsx("input",{type:"range",min:50,max:200,step:1,value:Math.round(f.scale*100),onChange:e=>j(t=>({...t,scale:Number(e.target.value)/100})),style:{flex:1}})]})]})]}),o.jsxs("div",{style:te,children:[o.jsx("button",{style:E,onClick:()=>j({...Y}),children:"Reset"}),o.jsx("button",{style:E,onClick:y,children:"Cancel"}),o.jsx("button",{style:{...oe,opacity:D||!b||$?.5:1},onClick:V,disabled:D||!b||$,children:$?"Processing with PhotoRoom...":"Save & Replace"})]})]})]}):null};export{ne as P};
