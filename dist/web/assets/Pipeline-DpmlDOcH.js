import{r as u,j as e,R as Q}from"./vendor-react-DzgxJkbp.js";import{u as X}from"./vendor-query-BeqrpgNA.js";import{g as E,f as q}from"./index-DJAOEm-v.js";import{I as b,T as l,e as j,X as F,a as f,a1 as te,C as y,h as H,P as ne,b as w,c as A,ad as re,E as ie,o as K,B as ae,S as U,D as J,f as V,ac as le,G as Y,d as oe,i as ce,ae as de,m as ue,af as pe,ag as ge,H as P}from"./vendor-polaris-o1SQP_xq.js";const he=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],me=E("circle-check",he);const fe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],xe=E("circle-x",fe);const be=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],je=E("circle",be);const ye=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Se=E("loader-circle",ye),Ie=[{name:"fetch_product",label:"Shopify Import"},{name:"generate_description",label:"AI Description"},{name:"process_images",label:"Image Processing"},{name:"create_ebay_listing",label:"Draft Creation"}],ke=4,Pe=({jobId:n,onComplete:d,compact:o})=>{const[i,p]=u.useState(Ie.map(s=>({name:s.name,label:s.label,status:"pending"}))),[c,S]=u.useState("queued"),[C,M]=u.useState(""),[g,I]=u.useState(null),[z,v]=u.useState(0),[T,N]=u.useState(0),[B,D]=u.useState(!1),L=u.useRef(null),t=u.useRef(null),r=u.useRef(!1);u.useEffect(()=>{if(!g||c==="completed"||c==="failed")return;const s=setInterval(()=>v(Math.floor((Date.now()-g)/1e3)),1e3);return()=>clearInterval(s)},[g,c]);const m=u.useCallback(s=>{if(s){if(S(s.status),s.shopifyTitle&&M(s.shopifyTitle),s.startedAt){const h=s.startedAt>1e12?s.startedAt:s.startedAt*1e3;I(h)}p(h=>h.map(a=>{const k=s.steps.find(se=>se.name===a.name);return k?{...a,status:k.status,result:k.result}:a}))}},[]),x=u.useCallback(s=>{s.shopifyTitle&&M(s.shopifyTitle),s.jobStatus&&(S(s.jobStatus),(s.jobStatus==="completed"||s.jobStatus==="failed")&&!r.current&&(r.current=!0,d?.(s.jobStatus,s.shopifyTitle))),!g&&s.status==="running"&&I(Date.now()),p(h=>h.map(a=>a.name!==s.step?a:{...a,status:s.status??a.status,result:s.detail??a.result,subDetail:s.progress?`${s.detail??""}`:s.status==="running"?s.detail:a.subDetail,progress:s.progress??a.progress})),s.progress?.total&&s.step==="process_images"&&N(s.progress.total)},[d,g]);u.useEffect(()=>{const s=new EventSource(`/api/pipeline/jobs/${n}/stream`);return L.current=s,s.onopen=()=>D(!0),s.onerror=()=>{D(!1),t.current||(t.current=setInterval(async()=>{try{const h=await fetch(`/api/pipeline/jobs/${n}`);if(h.ok){const a=await h.json();m(a)}}catch{}},1e4))},s.onmessage=h=>{try{const a=JSON.parse(h.data);a.type==="snapshot"?m(a.job):x(a)}catch{}},()=>{s.close(),t.current&&clearInterval(t.current)}},[n,m,x]);const W=u.useMemo(()=>{const s=i.filter(k=>k.status==="done").length,h=i.find(k=>k.status==="running");let a=0;return h?.progress&&(a=h.progress.current/h.progress.total),Math.round((s+a*.9)/i.length*100)},[i]),R=u.useMemo(()=>{if(c==="completed")return"Done";if(c==="failed")return"Failed";const s=i.find(h=>h.status==="running");if(!s)return"";if(s.name==="process_images"&&T>0&&s.progress){const a=(T-s.progress.current)*ke;return a>60?`~${Math.ceil(a/60)}m remaining`:`~${a}s remaining`}return""},[i,c,T]),ee=s=>s<60?`${s}s`:`${Math.floor(s/60)}m ${s%60}s`,G=s=>{switch(s){case"done":return e.jsx(me,{size:18,color:"#22c55e"});case"running":return e.jsx(Se,{size:18,color:"#f59e0b",className:"pipeline-spin"});case"error":return e.jsx(xe,{size:18,color:"#ef4444"});default:return e.jsx(je,{size:18,color:"#d1d5db"})}};return o?e.jsxs("div",{style:{padding:"12px 0"},children:[e.jsxs(b,{gap:"200",blockAlign:"center",children:[i.map(s=>e.jsx("span",{title:`${s.label}: ${s.status}`,children:G(s.status)},s.name)),e.jsx(l,{as:"span",variant:"bodySm",tone:"subdued",children:C||n}),R&&e.jsx(j,{tone:"info",children:R})]}),e.jsx("div",{style:{marginTop:6},children:e.jsx(F,{progress:W,size:"small",tone:c==="failed"?"critical":"primary"})})]}):e.jsxs("div",{className:"pipeline-progress-container",children:[e.jsxs(b,{align:"space-between",blockAlign:"center",children:[e.jsxs(f,{gap:"100",children:[e.jsx(l,{as:"h3",variant:"headingMd",children:C||"Processing..."}),e.jsxs(b,{gap:"200",children:[e.jsx(j,{tone:c==="completed"?"success":c==="failed"?"critical":"attention",children:c}),!B&&e.jsx(j,{tone:"warning",children:"Polling"})]})]}),e.jsxs(f,{gap:"050",inlineAlign:"end",children:[e.jsxs(l,{as:"span",variant:"bodySm",tone:"subdued",children:["Elapsed: ",ee(z)]}),R&&e.jsx(l,{as:"span",variant:"bodySm",tone:"subdued",children:R}),c==="processing"&&e.jsx("button",{onClick:async()=>{try{await fetch(`/api/pipeline/jobs/${n}/cancel`,{method:"POST"})}catch{}},style:{marginTop:"4px",padding:"4px 12px",fontSize:"12px",background:"#dc2626",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"✕ Cancel"})]})]}),e.jsx("div",{style:{margin:"16px 0"},children:e.jsx(F,{progress:W,size:"small",tone:c==="failed"?"critical":"primary"})}),e.jsx(f,{gap:"300",children:i.map(s=>e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"12px",padding:"8px 12px",borderRadius:"8px",background:s.status==="running"?"rgba(245, 158, 11, 0.08)":s.status==="done"?"rgba(34, 197, 94, 0.05)":s.status==="error"?"rgba(239, 68, 68, 0.06)":"transparent",transition:"background 0.3s"},children:[e.jsx("div",{style:{marginTop:2},children:G(s.status)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx(l,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:s.label}),s.subDetail&&s.status==="running"&&e.jsx("div",{style:{marginTop:2},children:e.jsx(l,{as:"span",variant:"bodySm",tone:"subdued",children:s.subDetail})}),s.progress&&s.status==="running"&&e.jsx("div",{style:{marginTop:4,maxWidth:200},children:e.jsx(F,{progress:Math.round(s.progress.current/s.progress.total*100),size:"small"})}),s.status==="done"&&s.result&&e.jsx("div",{style:{marginTop:2},children:e.jsx(l,{as:"span",variant:"bodySm",tone:"subdued",children:s.result})}),s.status==="error"&&s.result&&e.jsx("div",{style:{marginTop:2},children:e.jsx(l,{as:"span",variant:"bodySm",tone:"critical",children:s.result})})]})]},s.name))})]})},_={fetch_product:"Shopify Import",generate_description:"AI Description",process_images:"Image Processing",create_ebay_listing:"eBay Listing"},Ce=[{key:"import",label:"Shopify Import",description:"Products ingested from catalog",icon:ce,tone:"info"},{key:"ai",label:"AI Description",description:"Optimized listing copy generated",icon:de,tone:"warning"},{key:"images",label:"Image Processing",description:"PhotoRoom templates applied",icon:ue,tone:"success"},{key:"listing",label:"eBay Listing",description:"Published to marketplace",icon:pe,tone:"info"}];function Z(n){if(n.currentStep)return n.currentStep;const d=n.steps?.find(i=>i.status==="running");if(d?.name&&_[d.name])return _[d.name];const o=n.steps?.find(i=>i.status==="pending");return o?.name&&_[o.name]?_[o.name]:"Shopify Import"}function O(n){if(n==null||n==="")return null;if(typeof n=="number")return n>1e12?n:n*1e3;const d=Date.parse(n);return Number.isNaN(d)?null:d}function ve(n){const d=O(n);if(!d)return"—";const o=new Date(d),p=new Date().getTime()-o.getTime();return p<6e4?"Just now":p<36e5?`${Math.floor(p/6e4)}m ago`:p<864e5?`${Math.floor(p/36e5)}h ago`:o.toLocaleDateString()}function we(n,d){const o=O(n);if(!o)return"—";const i=O(d)??Date.now(),p=Math.max(0,i-o),c=Math.floor(p/6e4),S=Math.floor(c/60),C=c%60;return S>0?`${S}h ${C}m`:c>0?`${c}m`:`${Math.max(1,Math.floor(p/1e3))}s`}function Te(n){switch(n){case"completed":return e.jsx(j,{tone:"success",children:"Completed"});case"processing":return e.jsx(j,{tone:"attention",children:"Processing"});case"queued":return e.jsx(j,{tone:"info",children:"Queued"});case"failed":return e.jsx(j,{tone:"critical",children:"Failed"});default:return e.jsx(j,{children:n})}}const Ae=({icon:n,label:d,description:o,count:i,tone:p})=>e.jsx(y,{children:e.jsxs(f,{gap:"300",inlineAlign:"center",children:[e.jsx(w,{background:p==="success"?"bg-fill-success-secondary":p==="warning"?"bg-fill-warning-secondary":"bg-fill-secondary",borderRadius:"200",padding:"300",children:e.jsx(A,{source:n,tone:p==="warning"?"warning":p==="success"?"success":"base"})}),e.jsx(l,{variant:"headingSm",as:"h3",alignment:"center",children:d}),e.jsx(l,{variant:"bodySm",tone:"subdued",as:"p",alignment:"center",children:o}),i>0&&e.jsx(j,{tone:"attention",children:`${i} active`})]})}),$=({label:n,value:d,icon:o,tone:i})=>e.jsx(y,{children:e.jsxs(f,{gap:"200",children:[e.jsx(b,{align:"space-between",blockAlign:"center",children:e.jsx(w,{background:i==="success"?"bg-fill-success-secondary":i==="critical"?"bg-fill-critical-secondary":i==="warning"?"bg-fill-warning-secondary":"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(A,{source:o,tone:i})})}),e.jsx(l,{variant:"headingXl",as:"p",children:d}),e.jsx(l,{variant:"bodySm",tone:"subdued",as:"p",children:n})]})}),$e=()=>{const[n,d]=u.useState(""),[o,i]=u.useState({loading:!1,result:null}),[p,c]=u.useState([]),S=u.useCallback(async()=>{const t=n.trim();if(t){i({loading:!0,result:null});try{const r=await q.post(`/auto-list/${encodeURIComponent(t)}`),m=r.jobId;i({loading:!1,result:{success:!0,message:r.message||"Pipeline job started",jobId:m}}),m&&c(x=>x.includes(m)?x:[m,...x])}catch(r){i({loading:!1,result:{success:!1,message:r?.message||"Failed to start pipeline job"}})}}},[n]),{data:C,isLoading:M}=X({queryKey:["pipeline-jobs"],queryFn:()=>q.get("/pipeline/jobs"),refetchInterval:1e4,retry:1}),g=C?.jobs??[];Q.useEffect(()=>{const t=g.filter(r=>r.status==="processing"||r.status==="queued").map(r=>r.id);t.length>0&&c(r=>Array.from(new Set([...r,...t])))},[g]);const I=Q.useMemo(()=>Array.from(new Set(g.filter(t=>!t.shopifyTitle&&t.shopifyProductId).map(t=>t.shopifyProductId))),[g]),{data:z}=X({queryKey:["pipeline-job-titles",I],queryFn:async()=>I.length===0?{}:(await Promise.all(I.map(async r=>{try{const m=await q.get(`/test/product-info/${encodeURIComponent(r)}`);return[r,m.product?.title??""]}catch{return[r,""]}}))).reduce((r,[m,x])=>(x&&(r[m]=x),r),{}),enabled:I.length>0,staleTime:300*1e3}),v=t=>g.filter(r=>Z(r)===t&&(r.status==="processing"||r.status==="queued")).length,T={import:v("Shopify Import"),ai:v("AI Description"),images:v("Image Processing"),listing:v("eBay Listing")},N=g.filter(t=>t.status==="completed").length,B=g.filter(t=>t.status==="processing").length,D=g.filter(t=>t.status==="queued").length,L=g.filter(t=>t.status==="failed").length;return M?e.jsx(te,{title:"Pipeline Overview",fullWidth:!0,children:e.jsxs(f,{gap:"400",children:[e.jsx(y,{children:e.jsx(H,{lines:3})}),e.jsx(y,{children:e.jsx(H,{lines:4})})]})}):e.jsx(ne,{title:"Pipeline Overview",subtitle:"Real-time product automation flow",fullWidth:!0,children:e.jsxs(f,{gap:"500",children:[e.jsx(y,{children:e.jsxs(f,{gap:"400",children:[e.jsxs(b,{gap:"200",blockAlign:"center",children:[e.jsx(w,{background:"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(A,{source:re})}),e.jsx(l,{as:"h2",variant:"headingMd",children:"Process Product"})]}),e.jsx(l,{as:"p",tone:"subdued",variant:"bodySm",children:"Enter a Shopify product ID to run it through the auto-listing pipeline."}),e.jsx(b,{gap:"300",blockAlign:"end",children:e.jsx(w,{minWidth:"320px",children:e.jsx(ie,{label:"Shopify Product ID",labelHidden:!0,value:n,onChange:d,placeholder:"e.g. 8012345678901",autoComplete:"off",connectedRight:e.jsx(K,{variant:"primary",onClick:S,loading:o.loading,disabled:!n.trim(),children:"Run Pipeline"})})})}),o.result&&e.jsx(ae,{tone:o.result.success?"success":"critical",title:o.result.message,onDismiss:()=>i(t=>({...t,result:null})),children:o.result.jobId&&e.jsxs(l,{as:"p",variant:"bodySm",tone:"subdued",children:["Job ID: ",o.result.jobId]})})]})}),p.length>0&&e.jsx(y,{children:e.jsxs(f,{gap:"400",children:[e.jsxs(b,{align:"space-between",blockAlign:"center",children:[e.jsxs(b,{gap:"200",blockAlign:"center",children:[e.jsx(w,{background:"bg-fill-warning-secondary",borderRadius:"200",padding:"200",children:e.jsx(A,{source:U,tone:"warning"})}),e.jsx(l,{as:"h2",variant:"headingMd",children:"Live Pipeline Progress"})]}),e.jsx(K,{size:"slim",onClick:async()=>{await fetch("/api/pipeline/jobs/clear-stuck",{method:"POST"}),c([])},children:"Clear All"})]}),e.jsx(J,{}),p.map(t=>e.jsx(Pe,{jobId:t,onComplete:()=>{setTimeout(()=>c(r=>r.filter(m=>m!==t)),1e4)}},t))]})}),e.jsxs(V,{columns:{xs:2,sm:4},gap:"300",children:[e.jsx($,{label:"Completed",value:N,icon:le,tone:"success"}),e.jsx($,{label:"Processing",value:B,icon:U,tone:"warning"}),e.jsx($,{label:"Queued",value:D,icon:Y,tone:"info"}),e.jsx($,{label:"Failed",value:L,icon:oe,tone:"critical"})]}),e.jsx(y,{children:e.jsxs(f,{gap:"300",children:[e.jsx(l,{variant:"headingMd",as:"h2",children:"Pipeline Flow"}),e.jsx(J,{}),e.jsx(V,{columns:{xs:2,sm:4},gap:"300",children:Ce.map(t=>e.jsx(Ae,{icon:t.icon,label:t.label,description:t.description,count:T[t.key]??0,tone:t.tone},t.key))})]})}),e.jsx(y,{children:e.jsxs(f,{gap:"400",children:[e.jsxs(b,{gap:"200",blockAlign:"center",children:[e.jsx(w,{background:"bg-fill-secondary",borderRadius:"200",padding:"200",children:e.jsx(A,{source:Y})}),e.jsx(l,{as:"h2",variant:"headingMd",children:"Recent Pipeline Jobs"})]}),e.jsx(J,{}),g.length===0?e.jsx(ge,{heading:"No pipeline jobs yet",image:"",children:e.jsx(l,{as:"p",tone:"subdued",children:"Enter a Shopify Product ID above to run the pipeline."})}):e.jsx(P,{resourceName:{singular:"job",plural:"jobs"},itemCount:g.length,headings:[{title:"Product"},{title:"Status"},{title:"Current Step"},{title:"Started"},{title:"Duration"}],selectable:!1,children:g.map((t,r)=>e.jsxs(P.Row,{id:t.id,position:r,children:[e.jsx(P.Cell,{children:e.jsx(l,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:t.shopifyTitle??z?.[t.shopifyProductId]??`Product ${t.shopifyProductId}`})}),e.jsx(P.Cell,{children:Te(t.status)}),e.jsx(P.Cell,{children:e.jsx(l,{as:"span",children:Z(t)})}),e.jsx(P.Cell,{children:e.jsx(l,{as:"span",tone:"subdued",children:ve(t.startedAt??t.createdAt??null)})}),e.jsx(P.Cell,{children:e.jsx(l,{as:"span",tone:"subdued",children:we(t.startedAt??t.createdAt??null,t.completedAt??null)})})]},t.id))})]})})]})})};export{$e as default};
